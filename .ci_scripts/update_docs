#!/usr/bin/env bash

set -ex

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR=$(dirname $HERE)

# configure bot account
if [[ "$CI" == "1" ]]; then
  git config --global user.email "pelson.pub+conda-forge@gmail.com"
  git config --global user.name "conda-forge-admin"
  git checkout -b new_site_content
fi

python "$BASE_DIR/.ci_scripts/generate_cfep_index.py"

pushd "$BASE_DIR/sphinx/src"
make clean
# -W --keep-going: list all warnings but fail build in case there are any
make markdown SPHINXOPTS="-W --keep-going"
popd

# Move rendered Sphinx markdown to Docusaurus
python "$BASE_DIR/.ci_scripts/sphinx_markdown_to_docusaurus.py" "$BASE_DIR/sphinx/src/_build/markdown" docs/

# Build docusaurus site
npm install
npm run build

# Serve the announcements RSS feed in this old location too
# we can't redirect with the Docusaurus plugin, so just copy it
cp build/news/rss.xml build/docs/news.rss
