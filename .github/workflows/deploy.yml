name: deploy

on:
  push:
    branches:
      - main
  pull_request: null
  workflow_dispatch: null

jobs:
  tests:
    name: deploy
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: prefix-dev/setup-pixi@a0af7a228712d6121d37aba47adf55c1332c9c2e # v0.9.4

      - name: build
        run: pixi run build-production
        env:
          GHREF: ${{ github.ref }}
          GHREPO: ${{ github.event.pull_request.head.repo.full_name || github.repository }}

      - name: deploy
        if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./build
          user_name: conda-forge-admin
          user_email: pelson.pub+conda-forge@gmail.com

      - name: Link Checker
        uses: lycheeverse/lychee-action@7cd0af4c74a61395d455af97419279d86aafaede # v2.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: >
            --no-progress
            --max-retries 10
            --timeout 60
            --base "$(pwd)/build"
            --accept 100..399,401,403,429
            --exclude '.*/status/migration/.*'
            --exclude 'https://polys.me/?$'
            --exclude 'https://conda-metadata-app.streamlit.app/?$'
            --exclude 'https://kb43fqob7u-dsn.algolia.net/'
            --exclude 'https://ss64.com/nt/syntax.html'
            --exclude 'https://www.mesa3d.org/'
            --exclude 'https://www.quansight.com/'
            --exclude 'https://conda-forge.herokuapp.com/status-monitor'
            --exclude 'https://osuosl.org/'
            --exclude 'https://cf-infra-docs.netlify.app/'
            --exclude '.*/404.html/'
            --exclude '.*,.*'
            --exclude-path './build/community/minutes/'
            --remap "https://conda-forge.org/(.*) file://$(pwd)/build/\$1"
            './build/**/*.html'
            '*.md'

      - name: Check Pixi and environment.yml are in sync
        run: |
          pixi workspace export conda-environment > .ci_scripts/environment.yml
          sed -i -e 's/name: default/name: conda-forge-docs/g' -e '/^$/d' .ci_scripts/environment.yml
          if ! git diff --exit-code .ci_scripts/environment.yml; then
            echo "error: pixi.toml and environment.yml are out of sync"
            exit 1
          fi
