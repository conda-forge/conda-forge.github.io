

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Knowledge Base &#8212; conda-forge 2023.06.22 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/cloud.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>

    
    
     
        <script src="../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../_static/cloud.base.js"></script>
    

    
     
        <script src="../_static/cloud.js"></script>
    

    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FAQ" href="maintainer_faq.html" />
    <link rel="prev" title="Configuring conda-forge.yml" href="conda_forge_yml.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="maintainer_faq.html" title="FAQ"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="conda_forge_yml.html" title="Configuring conda-forge.yml"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">conda-forge 2023.06.22 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="00_intro.html" accesskey="U">Maintainer Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Knowledge Base</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="knowledge-base">
<h1>Knowledge Base<a class="headerlink" href="#knowledge-base" title="Permalink to this heading">¶</a></h1>
<section id="using-cmake">
<h2>Using CMake<a class="headerlink" href="#using-cmake" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="https://cmake.org/">CMake</a> can be used to build more complex projects in <code class="docutils literal notranslate"><span class="pre">build.sh</span></code>
or <code class="docutils literal notranslate"><span class="pre">bld.bat</span></code> scripts.</p>
<p>If you are using cmake, be sure to make it a build requirement in the <code class="docutils literal notranslate"><span class="pre">build</span></code> section. You
may also need to include <code class="docutils literal notranslate"><span class="pre">make</span></code> or <code class="docutils literal notranslate"><span class="pre">ninja</span></code> depending on your platform and build tools.
On Windows, you can also use <code class="docutils literal notranslate"><span class="pre">nmake</span></code> to build, but that does not need to be explicitly included.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cmake</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make</span><span class="w">  </span><span class="c1"># [not win]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ninja</span><span class="w">  </span><span class="c1"># [win]</span>
</pre></div>
</div>
<p>For CMake projects using the <a class="reference external" href="https://cmake.org/cmake/help/git-stage/module/FindPython.html">FindPython</a>
module, you can tell CMake which Python to use by passing <code class="docutils literal notranslate"><span class="pre">-DPython_EXECUTABLE=&quot;$PYTHON&quot;</span></code>
(macOS or Linux) or <code class="docutils literal notranslate"><span class="pre">-DPython_EXECUTABLE=&quot;%PYTHON%&quot;</span></code> (Windows) as a command line option.
Older CMake projects may require similar, but slightly different options.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don’t forget that depending on which CMake module you use you have to use a different command:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://cmake.org/cmake/help/git-stage/module/FindPython.html">FindPython</a>:
<code class="docutils literal notranslate"><span class="pre">-DPython_EXECUTABLE=...</span></code>.</p></li>
<li><p><a class="reference external" href="https://cmake.org/cmake/help/git-stage/module/FindPython3.html">FindPython3</a>:
<code class="docutils literal notranslate"><span class="pre">-DPython3_EXECUTABLE=...</span></code>.</p></li>
<li><p><a class="reference external" href="https://cmake.org/cmake/help/git-stage/module/FindPython2.html">FindPython2</a>:
<code class="docutils literal notranslate"><span class="pre">-DPython2_EXECUTABLE=...</span></code>.</p></li>
</ul>
<p>or if you are still on the deprecated <a class="reference external" href="https://cmake.org/cmake/help/latest/module/FindPythonLibs.html">FindPythonLibs</a>: <code class="docutils literal notranslate"><span class="pre">-DPYTHON_EXECUTABLE=...</span></code>.</p>
</div>
<p>Some optional, but useful CMake options:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-DCMAKE_BUILD_TYPE=Release</span></code> Configure as release build. This is better done on the initial
<code class="docutils literal notranslate"><span class="pre">cmake</span></code> call as some packages construct different build configurations depending on this flag.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-DCMAKE_INSTALL_PREFIX=$PREFIX</span></code> Specify the install location.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-DCMAKE_INSTALL_LIBDIR=lib</span></code> Libraries will land in $PREFIX/lib, sometimes projects install
into lib64 or similar but on conda-forge we keep shared libraries in simply lib.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-DBUILD_SHARED_LIBS=ON</span></code> Instruct CMake to build shared libraries instead of static ones.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-DCMAKE_FIND_FRAMEWORK=NEVER</span></code> and <code class="docutils literal notranslate"><span class="pre">-DCMAKE_FIND_APPBUNDLE=NEVER</span></code> Prevent CMake from using system-wide macOS packages.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">${CMAKE_ARGS}</span></code> Add variables defined by conda-forge internally. This is required to enable various conda-forge enhancements, like <a class="reference external" href="https://conda-forge.org/docs/maintainer/knowledge_base.html#cuda-builds">CUDA builds</a>.</p></li>
</ul>
</div></blockquote>
<p>Here are some basic commands for you to get started. These are dependent on your source
code layout and aren’t intended to be used “as is”.</p>
<p><strong>CMake lines for build.sh (macOS/Linux):</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cmake</span> <span class="n">CMakeLists</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">DPython3_EXECUTABLE</span><span class="o">=</span><span class="s2">&quot;$PYTHON&quot;</span>
<span class="n">cmake</span> <span class="o">--</span><span class="n">build</span> <span class="o">.</span> <span class="o">--</span><span class="n">config</span> <span class="n">Release</span>
</pre></div>
</div>
<p><strong>CMake lines for bld.bat (Windows):</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cmake</span> <span class="o">-</span><span class="n">G</span> <span class="s2">&quot;NMake Makefiles&quot;</span> <span class="o">-</span><span class="n">DCMAKE_BUILD_TYPE</span><span class="o">=</span><span class="n">Release</span> <span class="o">-</span><span class="n">DPython3_EXECUTABLE</span><span class="o">=</span><span class="s2">&quot;%PYTHON%&quot;</span>
<span class="k">if</span> <span class="n">errorlevel</span> <span class="mi">1</span> <span class="n">exit</span> <span class="o">/</span><span class="n">b</span> <span class="mi">1</span>
<span class="n">cmake</span> <span class="o">--</span><span class="n">build</span> <span class="o">.</span> <span class="o">--</span><span class="n">config</span> <span class="n">Release</span>
<span class="k">if</span> <span class="n">errorlevel</span> <span class="mi">1</span> <span class="n">exit</span> <span class="o">/</span><span class="n">b</span> <span class="mi">1</span>
</pre></div>
</div>
<p>See also the <code class="docutils literal notranslate"><span class="pre">bld.bat</span></code> in the Windows section below for an additional example.</p>
<p>Other useful <code class="docutils literal notranslate"><span class="pre">cmake</span></code> options are <code class="docutils literal notranslate"><span class="pre">-B&lt;directory&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">-S&lt;directory&gt;</span></code> to specify build and source
directories.</p>
<section id="moving-from-an-autotools-build-to-a-cmake-build">
<h3>Moving from an autotools build to a CMake build<a class="headerlink" href="#moving-from-an-autotools-build-to-a-cmake-build" title="Permalink to this heading">¶</a></h3>
<p>Some packages maintain an autotools build and a cmake build. Some maintainers
would like to switch to a cmake build because that provides windows builds
easily. These builds are mostly not ABI compatible with each other.
Here are some things you should check,</p>
<ol class="arabic">
<li><p>Check that both libraries have the same SONAME on linux</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">readelf</span> <span class="pre">-d</span> <span class="pre">/path/to/lib.so</span></code></p>
</li>
<li><p>Check that both libraries have the same install name and have the same
compatibility and current versions.</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">otool</span> <span class="pre">-L</span> <span class="pre">/path/to/lib.dylib</span></code>. The second line should give you
the three pieces of information</p>
</li>
<li><p>Check that the file list is the same in both.</p></li>
<li><p>Check that you use the same options as the same autoconf build.</p></li>
<li><p>Check that the symbols exported are the same.</p></li>
<li><p>Check that additional packaging information stays the same, e.g. is the same pkg-config information provided.</p></li>
</ol>
</section>
</section>
<section id="particularities-on-windows">
<h2>Particularities on Windows<a class="headerlink" href="#particularities-on-windows" title="Permalink to this heading">¶</a></h2>
<p>This document presents conda-forge and conda-build information and examples
while building on Windows.</p>
<section id="local-testing">
<h3>Local testing<a class="headerlink" href="#local-testing" title="Permalink to this heading">¶</a></h3>
<p>The first thing that you should know is that you can locally test Windows
builds of your packages even if you don’t own a Windows machine. Microsoft
makes available free, official Windows virtual machines (VMs) <a class="reference external" href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">at this website</a>. If you
are unfamiliar with VM systems or have trouble installing Microsoft’s VMs, please
use a general web search to explore — while these topics are beyond the
scope of this documentation, there are ample discussions on them on the broader
Internet.</p>
<p>In order to compile native code (C, C++, etc.) on Windows, you will need to
install Microsoft’s Visual C++ build tools on your VM. You must install
particular versions of these tools — this is to maintain compatibility between
compiled libraries used in Python, <a class="reference external" href="https://wiki.python.org/moin/WindowsCompilers">as described on this Python wiki page</a>. The current relevant
versions are:</p>
<ul class="simple">
<li><p>For Python 3.5–3.7: Visual C++ 14.0</p></li>
</ul>
<p>While you can obtain these tools by installing the right version of the full
<a class="reference external" href="https://visualstudio.microsoft.com/">Visual Studio</a> development
environment, you can save a lot of time and bandwidth by installing standalone
“build tools” packages. The links are as follows:</p>
<ul class="simple">
<li><p>For Python 3.5–3.7: <a class="reference external" href="https://visualstudio.microsoft.com/vs/older-downloads/#visual-studio-2017-and-other-products">Microsoft Build Tools for Visual Studio 2017</a>.</p></li>
</ul>
<p>If you need more information. Please refer <a class="reference external" href="https://wiki.python.org/moin/WindowsCompilers">the Python wiki page on Windows compilers</a>.</p>
</section>
<section id="simple-cmake-based-bld-bat">
<h3>Simple CMake-Based <code class="docutils literal notranslate"><span class="pre">bld.bat</span></code><a class="headerlink" href="#simple-cmake-based-bld-bat" title="Permalink to this heading">¶</a></h3>
<p>Some projects provide hooks for CMake to build the project. The following
example <code class="docutils literal notranslate"><span class="pre">bld.bat</span></code> file demonstrates how to build a traditional, out-of-core
build for such projects.</p>
<p><strong>CMake-based bld.bat:</strong></p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="k">setlocal</span> EnableDelayedExpansion

<span class="p">:</span><span class="c1">: Make a build folder and change to it.</span>
<span class="k">mkdir</span> build
<span class="k">cd</span> build

<span class="p">:</span><span class="c1">: Configure using the CMakeFiles</span>
cmake -G <span class="s2">&quot;NMake Makefiles&quot;</span> <span class="se">^</span>
<span class="se"> </span>     -DCMAKE_INSTALL_PREFIX:PATH=<span class="s2">&quot;</span><span class="nv">%LIBRARY_PREFIX%</span><span class="s2">&quot;</span> <span class="se">^</span>
<span class="se"> </span>     -DCMAKE_PREFIX_PATH:PATH=<span class="s2">&quot;</span><span class="nv">%LIBRARY_PREFIX%</span><span class="s2">&quot;</span> <span class="se">^</span>
<span class="se"> </span>     -DCMAKE_BUILD_TYPE:STRING=Release <span class="se">^</span>
<span class="se"> </span>     ..
<span class="k">if</span> <span class="k">errorlevel</span> <span class="mi">1</span> <span class="k">exit</span> 1

<span class="p">:</span><span class="c1">: Build!</span>
nmake
<span class="k">if</span> <span class="k">errorlevel</span> <span class="mi">1</span> <span class="k">exit</span> 1

<span class="p">:</span><span class="c1">: Install!</span>
nmake install
<span class="k">if</span> <span class="k">errorlevel</span> <span class="mi">1</span> <span class="k">exit</span> 1
</pre></div>
</div>
<p>The following feedstocks are examples of this build structure deployed:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/conda-forge/libpng-feedstock/blob/master/recipe/bld.bat">libpng</a></p></li>
<li><p><a class="reference external" href="https://github.com/conda-forge/pugixml-feedstock/blob/master/recipe/bld.bat">Pugixml</a></p></li>
</ul>
</section>
<section id="building-for-different-vc-versions">
<h3>Building for different VC versions<a class="headerlink" href="#building-for-different-vc-versions" title="Permalink to this heading">¶</a></h3>
<p>On Windows, different Visual C versions have different ABI and therefore a package needs to be built for different
Visual C versions. Packages are tied to the VC version that they were built with and some packages have specific
requirements of the VC version. For example, python 2.7 requires <code class="docutils literal notranslate"><span class="pre">vc</span> <span class="pre">9</span></code> and python 3.5 requires <code class="docutils literal notranslate"><span class="pre">vc</span> <span class="pre">14</span></code>.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">conda-build</span> <span class="pre">3.x</span></code>, <code class="docutils literal notranslate"><span class="pre">vc</span></code> can be used as a selector when using the <code class="docutils literal notranslate"><span class="pre">compiler</span></code> jinja syntax.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;cxx&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>To skip building with a particular <code class="docutils literal notranslate"><span class="pre">vc</span></code> version, add a skip statement.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># [win and vc&lt;14]</span>

<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;cxx&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
</section>
<section id="using-vs2019">
<h3>Using vs2019<a class="headerlink" href="#using-vs2019" title="Permalink to this heading">¶</a></h3>
<p>To use <code class="docutils literal notranslate"><span class="pre">vs2019</span></code> make the following changes:</p>
<p>In <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">c_compiler</span><span class="p">:</span><span class="w">    </span><span class="c1"># [win]</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vs2019</span><span class="w">       </span><span class="c1"># [win]</span>
<span class="nt">cxx_compiler</span><span class="p">:</span><span class="w">  </span><span class="c1"># [win]</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vs2019</span><span class="w">       </span><span class="c1"># [win]</span>
</pre></div>
</div>
<p>For example see the changes made in the <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> files in <a class="reference external" href="https://github.com/conda-forge/libignition-msgs1-feedstock/pull/73/commits/81b5ee0e1d23f7f20427dd80d04cf1f7321b441d">this</a> commit.</p>
<p>After making these changes don’t forget to rerender with <code class="docutils literal notranslate"><span class="pre">conda-smithy</span></code> (to rerender manually use <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">smithy</span> <span class="pre">rerender</span></code> from the command line).</p>
</section>
<section id="tips-tricks-for-cmd-batch-syntax">
<span id="cmd-batch-syntax"></span><h3>Tips &amp; tricks for CMD/Batch syntax<a class="headerlink" href="#tips-tricks-for-cmd-batch-syntax" title="Permalink to this heading">¶</a></h3>
<p>Windows recipes rely on CMD/Batch scripts (<code class="docutils literal notranslate"><span class="pre">.bat</span></code>) by default.
Batch syntax is a bit different from Bash and friends on Unix, so we have collected some tips here to help you get started if you are not familiar with this scripting language.</p>
<ul class="simple">
<li><p>Check if you need to write a Batch script first!
Simple recipes might not need shell-specific code and can be written in an agnostic way.
Use the <code class="docutils literal notranslate"><span class="pre">build.script</span></code> item in <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> (see <a class="reference external" href="https://docs.conda.io/projects/conda-build/en/stable/resources/define-metadata.html#script">conda-build docs</a>).
This item can take a string or a list of strings (one per line).</p></li>
<li><p><a class="reference external" href="https://ss64.com/nt/syntax.html">SS64’s CMD howto pages</a> are the best resource for any kind of question regarding CMD/Batch syntax.</p></li>
<li><p>Search conda-forge for existing <code class="docutils literal notranslate"><span class="pre">.bat</span></code> scripts and learn with examples.
See this <a class="reference external" href="https://github.com/search?q=org%3Aconda-forge+language%3ABatchfile&amp;type=code&amp;l=Batchfile">example query for all Batchfiles</a>.</p></li>
<li><p>You can <a class="reference external" href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">free trial Windows VMs from Microsoft</a>.
Set one up with your favorite virtualization solution to debug your CMD syntax.
There are also some minimal emulators online that might get you started with the basics, even if not all CMD features are present.
For example, this <a class="reference external" href="https://www.pcjs.org/software/pcx86/sys/windows/win95/4.00.950/">Windows 95 emulator</a> features a more or less okay MS-DOS prompt.</p></li>
</ul>
</section>
</section>
<section id="special-dependencies-and-packages">
<h2>Special Dependencies and Packages<a class="headerlink" href="#special-dependencies-and-packages" title="Permalink to this heading">¶</a></h2>
<section id="compilers">
<span id="dep-compilers"></span><h3>Compilers<a class="headerlink" href="#compilers" title="Permalink to this heading">¶</a></h3>
<p>Compilers are dependencies with a special syntax and are always added to <code class="docutils literal notranslate"><span class="pre">requirements/build</span></code>.</p>
<p>There are currently five supported compilers:</p>
<blockquote>
<div><ul class="simple">
<li><p>C</p></li>
<li><p>cxx</p></li>
<li><p>Fortran</p></li>
<li><p>Go</p></li>
<li><p>Rust</p></li>
</ul>
</div></blockquote>
<p>A package that needs all five compilers would define</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;c&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;cxx&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;fortran&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;go&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;rust&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Appropriate compiler runtime packages will be automatically added to the package’s runtime requirements and therefore
there’s no need to specify <code class="docutils literal notranslate"><span class="pre">libgcc</span></code> or <code class="docutils literal notranslate"><span class="pre">libgfortran</span></code>. There are additional informations about how conda-build 3 treats
compilers in the <a class="reference external" href="https://docs.conda.io/projects/conda-build/en/stable/resources/compiler-tools.html">conda docs</a>.</p>
</div>
</section>
<section id="cross-compilation">
<h3>Cross-compilation<a class="headerlink" href="#cross-compilation" title="Permalink to this heading">¶</a></h3>
<p>For some other architectures (like ARM), packages can be built natively on that architecture or they can be cross-compiled.
In other words built on a different common architecture (like x86_64) while still targeting the original architecture (ARM).
This helps one leverage more abundant CI resources in the build architecture (x86_64).</p>
<p>A package needs to make a few changes in their recipe to be compatible with cross-compilation. Here are a few examples.</p>
<p>A simple C library using autotools for cross-compilation might look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&quot;c&quot;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pkg-config</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gnuconfig</span>
</pre></div>
</div>
<p>In the build script, it would need to update the config files and guard any tests when cross-compiling:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get an updated config.sub and config.guess</span>
cp<span class="w"> </span><span class="nv">$BUILD_PREFIX</span>/share/gnuconfig/config.*<span class="w"> </span>.

<span class="c1"># Skip ``make check`` when cross-compiling</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CONDA_BUILD_CROSS_COMPILATION</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span>make<span class="w"> </span>check
<span class="k">fi</span>
</pre></div>
</div>
<p>A simple Python extension using Cython and NumPy’s C API would look like so:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&quot;c&quot;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cross-python_{{ target_platform }}</span><span class="w">    </span><span class="c1"># [build_platform != target_platform]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span><span class="w">                                </span><span class="c1"># [build_platform != target_platform]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cython</span><span class="w">                                </span><span class="c1"># [build_platform != target_platform]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy</span><span class="w">                                 </span><span class="c1"># [build_platform != target_platform]</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cython</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">pin_compatible(&quot;numpy&quot;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>There are more variations of this approach in the wild. So this is not meant to be exhaustive,
but merely to provide a starting point with some guidelines. Please look at <a class="reference external" href="https://github.com/search?q=org%3Aconda-forge+path%3Arecipe%2Fmeta.yaml+%22%5Bbuild_platform+%21%3D+target_platform%5D%22&amp;type=code">other recipes for more examples</a>.</p>
</section>
<section id="rust-nightly">
<h3>Rust Nightly<a class="headerlink" href="#rust-nightly" title="Permalink to this heading">¶</a></h3>
<p>Many rust packages rely on nightly versions of the rust compiler. Given this fast release cadence, <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> does not yet pull each release.
Instead, rust nightly versions are pulled into the <code class="docutils literal notranslate"><span class="pre">dev</span></code> branch of the <a class="reference external" href="https://github.com/conda-forge/rust-feedstock/tree/dev">conda-forge/rust-feedstock</a> on an as-needed basis.
For a new version, please file an issue on that feedstock.</p>
<p>To enable the rust nightly compiler in your feedstock, follow the section above and then add the <code class="docutils literal notranslate"><span class="pre">rust_dev</span></code> channel in the <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">channel_sources</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge/label/rust_dev,conda-forge</span>
</pre></div>
</div>
</section>
<section id="core-dependency-tree-packages-cdts">
<span id="cdt-packages"></span><h3>Core Dependency Tree Packages (CDTs)<a class="headerlink" href="#core-dependency-tree-packages-cdts" title="Permalink to this heading">¶</a></h3>
<p>Dependencies outside of the <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> channel should be avoided (see <a class="reference internal" href="adding_pkgs.html#no-external-deps"><span class="std std-ref">Avoid external dependencies</span></a>).
However, there are a few exceptions:</p>
<p>Some dependencies are so close to the system that they are not packaged with <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code>.
These dependencies have to be satisfied with <em>Core Dependency Tree</em> (CDT) packages.</p>
<p>A CDT package consists of repackaged CentOS binaries from the appropriate version,
either 6 or 7 depending on user choice and platform. We manage the build of CDT
packages using a centralized repo, <a class="reference external" href="https://github.com/conda-forge/cdt-builds">conda-forge/cdt-builds</a>,
as opposed to generating feedstocks for them. (Note that historically we did use feedstocks but this
practice has been deprecated.) To add a new CDT, make a PR on the
<a class="reference external" href="https://github.com/conda-forge/cdt-builds">conda-forge/cdt-builds</a> repo.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> the primary usages of CDTs is currently for packages that link against libGL.</p>
<section id="libgl">
<h4>libGL<a class="headerlink" href="#libgl" title="Permalink to this heading">¶</a></h4>
<p>In addition to the required compilers <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">compiler('c')</span> <span class="pre">}}</span></code> and/or <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">compiler('cxx')</span> <span class="pre">}}</span></code>,
the following CDT packages are required for linking against libGL:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cdt(&#39;mesa-libgl-devel&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [linux]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cdt(&#39;mesa-dri-drivers&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [linux]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cdt(&#39;libselinux&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [linux]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cdt(&#39;libxdamage&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [linux]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cdt(&#39;libxxf86vm&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [linux]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cdt(&#39;libxext&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">     </span><span class="c1"># [linux]</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xorg-libxfixes</span><span class="w">  </span><span class="c1"># [linux]</span>
</pre></div>
</div>
<p>If you need a fully functional binary in the test phase, you have to also provide the shared
libraries via <code class="docutils literal notranslate"><span class="pre">yum_requirements.txt</span></code> (see <a class="reference internal" href="#yum-deps"><span class="std std-ref">yum_requirements.txt</span></a>).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mesa-libGL
mesa-dri-drivers
libselinux
libXdamage
libXxf86vm
libXext
</pre></div>
</div>
<p>You will need to re-render the feedstock after making these changes.</p>
</section>
</section>
<section id="building-against-numpy">
<span id="linking-numpy"></span><h3>Building Against NumPy<a class="headerlink" href="#building-against-numpy" title="Permalink to this heading">¶</a></h3>
<p>Packages that link against NumPy need special treatment in the dependency section.
Finding <code class="docutils literal notranslate"><span class="pre">numpy.get_include()</span></code> in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> or <code class="docutils literal notranslate"><span class="pre">cimport</span></code> statements in <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> or <code class="docutils literal notranslate"><span class="pre">.pyd</span></code> files are a telltale sign that the package links against NumPy.</p>
<p>In the case of linking, you need to use the <code class="docutils literal notranslate"><span class="pre">pin_compatible</span></code> function to ensure having a compatible numpy version at run time:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">host</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy</span>
<span class="nt">run</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">pin_compatible(&#39;numpy&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>At the time of writing (January 22, 2022), above is equivalent to the following,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">host</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy   1.18</span><span class="w">   </span><span class="c1"># [py==37]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy   1.18</span><span class="w">   </span><span class="c1"># [py==38]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy   1.19</span><span class="w">   </span><span class="c1"># [py==39]</span>
<span class="nt">run</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy &gt;=1.18.5,&lt;2.0.a0</span><span class="w">   </span><span class="c1"># [py==37]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy &gt;=1.18.5,&lt;2.0.a0</span><span class="w">   </span><span class="c1"># [py==38]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy &gt;=1.19.5,&lt;2.0.a0</span><span class="w">   </span><span class="c1"># [py==39]</span>
</pre></div>
</div>
<p>See the pinning repository for what the pinning corresponds to at time of writing
<a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock/blob/master/recipe/conda_build_config.yaml#L631">https://github.com/conda-forge/conda-forge-pinning-feedstock/blob/master/recipe/conda_build_config.yaml#L631</a></p>
<div class="admonition-notes admonition">
<p class="admonition-title">Notes</p>
<p>1. You still need to respect minimum supported version of <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for the package!
That means you cannot use <code class="docutils literal notranslate"><span class="pre">numpy</span> <span class="pre">1.9</span></code> if the project requires at least <code class="docutils literal notranslate"><span class="pre">numpy</span> <span class="pre">1.12</span></code>,
adjust the minimum version accordingly!</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">host</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy 1.12.*</span>
<span class="nt">run</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">pin_compatible(&#39;numpy&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>2. if your package supports <code class="docutils literal notranslate"><span class="pre">numpy</span> <span class="pre">1.7</span></code>, and you are brave enough :-),
there are <code class="docutils literal notranslate"><span class="pre">numpy</span></code> packages for <code class="docutils literal notranslate"><span class="pre">1.7</span></code> available for Python 2.7 in the channel.</p>
</div>
</section>
<section id="jupyterlab-extensions">
<span id="jupyterlab-extension"></span><h3>JupyterLab Extensions<a class="headerlink" href="#jupyterlab-extensions" title="Permalink to this heading">¶</a></h3>
<p>A typical JupyterLab extension has both Python and JavaScript components.
These should be packaged together, to prevent node from being needing to
grab the JavaScript side of the package on the user’s machine. To package
an extension, the build should have the following <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> snippet:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">noarch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>


<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nodejs</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nodejs</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jupyterlab &gt;=2</span>
</pre></div>
</div>
<p>Please use the following <code class="docutils literal notranslate"><span class="pre">build.sh</span></code> script in your recipe:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-ex

<span class="nv">$PYTHON</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>.<span class="w"> </span>-vv
npm<span class="w"> </span>pack<span class="w"> </span><span class="si">${</span><span class="nv">PKG_NAME</span><span class="si">}</span>@<span class="si">${</span><span class="nv">PKG_VERSION</span><span class="si">}</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">PREFIX</span><span class="si">}</span>/share/jupyter/lab/extensions/js
cp<span class="w"> </span><span class="si">${</span><span class="nv">PKG_NAME</span><span class="si">}</span>-<span class="si">${</span><span class="nv">PKG_VERSION</span><span class="si">}</span>.tgz<span class="w"> </span><span class="si">${</span><span class="nv">PREFIX</span><span class="si">}</span>/share/jupyter/lab/extensions/js
</pre></div>
</div>
<p>Since this is a noarch recipe, the build script only needs to run on <code class="docutils literal notranslate"><span class="pre">linux-64</span></code>.
Also note that we do not need to run <code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">labextension</span> <span class="pre">install</span></code>  or
<code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">lab</span> <span class="pre">build</span></code> as part of the package build or in any post-link scripts.
This is because JupyterLab will run the build step itself when it is next run.
The <code class="docutils literal notranslate"><span class="pre">${PREFIX}/share/jupyter/lab/extensions/js</span></code> directory which JupyterLab
knows to build from when performing this build step.</p>
</section>
<section id="message-passing-interface-mpi">
<h3>Message passing interface (MPI)<a class="headerlink" href="#message-passing-interface-mpi" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section originates from Min’s notes: <a class="reference external" href="https://hackmd.io/ry4uI0thTs2q_b4mAQd_qg">https://hackmd.io/ry4uI0thTs2q_b4mAQd_qg</a></p>
</div>
<section id="mpi-variants-in-conda-forge">
<h4>MPI Variants in conda-forge<a class="headerlink" href="#mpi-variants-in-conda-forge" title="Permalink to this heading">¶</a></h4>
<p>How are MPI variants best handled in conda-forge?</p>
<p>There are a few broad cases:</p>
<ul class="simple">
<li><p>package requires a specific MPI provider (easy!)</p></li>
<li><p>the package works with any MPI provider (e.g. mpich, openmpi)</p></li>
<li><p>the package works with/without MPI</p></li>
</ul>
<p>Note that sometimes users want to use packages in <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> built against
our MPI libraries but linked to external MPI libraries at runtime. If you are interested
in this procedure, see <a class="reference internal" href="../user/tipsandtricks.html#using-external-message-passing-interface-mpi-libraries"><span class="std std-ref">Using External Message Passing Interface (MPI) Libraries</span></a>
for details.</p>
</section>
<section id="building-mpi-variants">
<h4>Building MPI variants<a class="headerlink" href="#building-mpi-variants" title="Permalink to this heading">¶</a></h4>
<p>In <cite>conda_build_config.yaml</cite>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mpi</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpich</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openmpi</span>
</pre></div>
</div>
<p>In <cite>meta.yaml</cite>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">mpi</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>And rerender with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda-smithy<span class="w"> </span>rerender<span class="w"> </span>-c<span class="w"> </span>auto
</pre></div>
</div>
<p>to produce the build matrices.</p>
</section>
<section id="including-a-no-mpi-build">
<h4>Including a no-mpi build<a class="headerlink" href="#including-a-no-mpi-build" title="Permalink to this heading">¶</a></h4>
<p>Some packages (e.g. hdf5) may want a no-mpi build, in addition to the mpi builds.
To do this, add <cite>nompi</cite> to the mpi matrix:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mpi</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nompi</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpich</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openmpi</span>
</pre></div>
</div>
<p>and apply the appropriate conditionals in your build:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">mpi</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [mpi != &#39;nompi&#39;]</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">mpi</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [mpi != &#39;nompi&#39;]</span>
</pre></div>
</div>
</section>
<section id="preferring-a-provider-usually-nompi">
<h4>Preferring a provider (usually nompi)<a class="headerlink" href="#preferring-a-provider-usually-nompi" title="Permalink to this heading">¶</a></h4>
<p>Up to here, mpi providers have no explicit preference. When choosing an MPI provider, the mutual exclusivity of
the <code class="docutils literal notranslate"><span class="pre">mpi</span></code> metapackage allows picking between mpi providers by installing an mpi provider, e.g.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span>mpich<span class="w"> </span>ptscotch
</pre></div>
</div>
<p>or</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span>openmpi<span class="w"> </span>ptscotch
</pre></div>
</div>
<p>This doesn’t extend to <code class="docutils literal notranslate"><span class="pre">nompi</span></code>, because there is no <code class="docutils literal notranslate"><span class="pre">nompi</span></code> variant of the mpi metapackage. And there probably
shouldn’t be, because some packages built with mpi don’t preclude other packages in the env that <em>may</em> have an mpi variant
from using the no-mpi variant of the library (e.g. for a long time, fenics used mpi with no-mpi hdf5 since there was no
parallel hdf5 yet. This works fine, though some features may not be available).</p>
<p>Typically, if there is a preference it will be for the serial build, such that installers/requirers of the package
only get the mpi build if explicitly requested. We use a higher build number for the <code class="docutils literal notranslate"><span class="pre">nompi</span></code> variant in this case.</p>
<p>Here is an example build section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">mpi</span> <span class="o">==</span> <span class="s1">&#39;nompi&#39;</span> <span class="o">%</span><span class="p">}</span>
<span class="c1"># prioritize nompi variant via build number</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">build</span> <span class="o">=</span> <span class="n">build</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="n">build</span><span class="p">:</span>
  <span class="n">number</span><span class="p">:</span> <span class="p">{{</span> <span class="n">build</span> <span class="p">}}</span>

  <span class="c1"># add build string so packages can depend on</span>
  <span class="c1"># mpi or nompi variants explicitly:</span>
  <span class="c1"># `pkg * mpi_mpich_*` for mpich</span>
  <span class="c1"># `pkg * mpi_*` for any mpi</span>
  <span class="c1"># `pkg * nompi_*` for no mpi</span>

  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">mpi</span> <span class="o">!=</span> <span class="s1">&#39;nompi&#39;</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">mpi_prefix</span> <span class="o">=</span> <span class="s2">&quot;mpi_&quot;</span> <span class="o">+</span> <span class="n">mpi</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">mpi_prefix</span> <span class="o">=</span> <span class="s2">&quot;nompi&quot;</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
  <span class="n">string</span><span class="p">:</span> <span class="s2">&quot;{{ mpi_prefix }}_h{{ PKG_HASH }}_{{ build }}&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">PKG_HASH</span> <span class="pre">}}</span></code> avoids build string collisions on <em>most</em> variants,
but not on packages that are excluded from the default build string,
e.g. Python itself. If the package is built for multiple Python versions, use:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">string</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">mpi_prefix</span><span class="nv"> </span><span class="s">}}_py{{</span><span class="nv"> </span><span class="s">py</span><span class="nv"> </span><span class="s">}}h{{</span><span class="nv"> </span><span class="s">PKG_HASH</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">build</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>as seen in <a class="reference external" href="https://github.com/conda-forge/h5py-feedstock/pull/49/commits/b08ee9307d16864e775f1a7f9dd10f25c83b5974">mpi4py</a></p>
</div>
<p>This build section creates the following packages:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pkg-x.y.z-mpi_mpich_h12345_0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pkg-x.y.z-mpi_openmpi_h23456_0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pkg-x.y.z-nompi_h34567_100</span></code></p></li>
</ul>
<p>Which has the following consequences:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">nompi</span></code> variant is preferred, and will be installed by default unless an mpi variant is explicitly requested.</p></li>
<li><p>mpi variants can be explicitly requested with <code class="docutils literal notranslate"><span class="pre">pkg=*=mpi_{{</span> <span class="pre">mpi</span> <span class="pre">}}_*</span></code></p></li>
<li><p>any mpi variant, ignoring provider, can be requested with <code class="docutils literal notranslate"><span class="pre">pkg=*=mpi_*</span></code></p></li>
<li><p>nompi variant can be explicitly requested with <code class="docutils literal notranslate"><span class="pre">pkg=*=nompi_*</span></code></p></li>
</ul>
<p>If building with this library creates a runtime dependency on the variant, the build string pinning can be added to <code class="docutils literal notranslate"><span class="pre">run_exports</span></code>.</p>
<p>For example, if building against the nompi variant will work with any installed version, but building with a
given mpi provider requires running with that mpi:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">build</span><span class="p">:</span>
  <span class="o">...</span>
  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">mpi</span> <span class="o">!=</span> <span class="s1">&#39;nompi&#39;</span> <span class="o">%</span><span class="p">}</span>
  <span class="n">run_exports</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span> <span class="o">*</span> <span class="p">{{</span> <span class="n">mpi_prefix</span> <span class="p">}}</span><span class="n">_</span><span class="o">*</span>
  <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>Remove the <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">mpi...</span></code> condition if all variants should create a strict runtime dependency based on the variant
chosen at build time (i.e. if the nompi build cannot be run against the mpich build).</p>
</section>
<section id="complete-example">
<h4>Complete example<a class="headerlink" href="#complete-example" title="Permalink to this heading">¶</a></h4>
<p>Combining all of the above, here is a complete recipe, with:</p>
<ul class="simple">
<li><p>nompi, mpich, openmpi variants</p></li>
<li><p>run-exports to apply mpi choice made at build time to runtime where nompi builds can be run with mpi, but not vice versa.</p></li>
<li><p>nompi variant is preferred by default</p></li>
<li><p>only build nompi on Windows</p></li>
</ul>
<p>This matches what is done in <a class="reference external" href="https://github.com/conda-forge/hdf5-feedstock/pull/90">hdf5</a>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># conda_build_config.yaml</span>
<span class="nt">mpi</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nompi</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpich</span><span class="w">  </span><span class="c1"># [not win]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openmpi</span><span class="w">  </span><span class="c1"># [not win]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># meta.yaml</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;pkg&#39;</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">build</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">%</span><span class="p">}</span>

<span class="c1"># ensure mpi is defined (needed for conda-smithy recipe-lint)</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">mpi</span> <span class="o">=</span> <span class="n">mpi</span> <span class="ow">or</span> <span class="s1">&#39;nompi&#39;</span> <span class="o">%</span><span class="p">}</span>

<span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">mpi</span> <span class="o">==</span> <span class="s1">&#39;nompi&#39;</span> <span class="o">%</span><span class="p">}</span>
<span class="c1"># prioritize nompi variant via build number</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">build</span> <span class="o">=</span> <span class="n">build</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>

<span class="n">build</span><span class="p">:</span>
  <span class="n">number</span><span class="p">:</span> <span class="p">{{</span> <span class="n">build</span> <span class="p">}}</span>

  <span class="c1"># add build string so packages can depend on</span>
  <span class="c1"># mpi or nompi variants explicitly:</span>
  <span class="c1"># `pkg * mpi_mpich_*` for mpich</span>
  <span class="c1"># `pkg * mpi_*` for any mpi</span>
  <span class="c1"># `pkg * nompi_*` for no mpi</span>

  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">mpi</span> <span class="o">!=</span> <span class="s1">&#39;nompi&#39;</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">mpi_prefix</span> <span class="o">=</span> <span class="s2">&quot;mpi_&quot;</span> <span class="o">+</span> <span class="n">mpi</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">mpi_prefix</span> <span class="o">=</span> <span class="s2">&quot;nompi&quot;</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
  <span class="n">string</span><span class="p">:</span> <span class="s2">&quot;{{ mpi_prefix }}_h{{ PKG_HASH }}_{{ build }}&quot;</span>

  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">mpi</span> <span class="o">!=</span> <span class="s1">&#39;nompi&#39;</span> <span class="o">%</span><span class="p">}</span>
  <span class="n">run_exports</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span> <span class="o">*</span> <span class="p">{{</span> <span class="n">mpi_prefix</span> <span class="p">}}</span><span class="n">_</span><span class="o">*</span>
  <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>

<span class="n">requirements</span><span class="p">:</span>
  <span class="n">host</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">mpi</span> <span class="p">}}</span>  <span class="c1"># [mpi != &#39;nompi&#39;]</span>
  <span class="n">run</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">mpi</span> <span class="p">}}</span>  <span class="c1"># [mpi != &#39;nompi&#39;]</span>
</pre></div>
</div>
<p>And then a package that depends on this one can explicitly pick the appropriate mpi builds:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># meta.yaml</span>

<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">mpi</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [mpi != &#39;nompi&#39;]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pkg</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pkg * mpi_{{ mpi }}_*</span><span class="w">  </span><span class="c1"># [mpi != &#39;nompi&#39;]</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">mpi</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w">  </span><span class="c1"># [mpi != &#39;nompi&#39;]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pkg * mpi_{{ mpi }}_*</span><span class="w">  </span><span class="c1"># [mpi != &#39;nompi&#39;]</span>
</pre></div>
</div>
<p>mpi-metapackage exclusivity allows <code class="docutils literal notranslate"><span class="pre">mpi_*</span></code> to resolve the same as <code class="docutils literal notranslate"><span class="pre">mpi_{{</span> <span class="pre">mpi</span> <span class="pre">}}_*</span></code>
if <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">mpi</span> <span class="pre">}}</span></code> is also a direct dependency, though it’s probably nicer to be explicit.</p>
</section>
<section id="just-mpi-example">
<h4>Just mpi example<a class="headerlink" href="#just-mpi-example" title="Permalink to this heading">¶</a></h4>
<p>Without a preferred <code class="docutils literal notranslate"><span class="pre">nompi</span></code> variant, recipes that require mpi are much simpler. This is all that is needed:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># conda_build_config.yaml</span>
<span class="nt">mpi</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpich</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openmpi</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># meta.yaml</span>
<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">mpi</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">mpi</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
</section>
<section id="mpi-compiler-packages">
<h4>MPI Compiler Packages<a class="headerlink" href="#mpi-compiler-packages" title="Permalink to this heading">¶</a></h4>
<p>Do not use the <code class="docutils literal notranslate"><span class="pre">[openmpi,mpich]-[mpicc,mpicxx,mpifort]</span></code> metapackages in the <code class="docutils literal notranslate"><span class="pre">requirements/build</span></code> section
of a recipe; the MPI compiler wrappers are included in the main <code class="docutils literal notranslate"><span class="pre">openmpi</span></code>/<code class="docutils literal notranslate"><span class="pre">mpich</span></code> packages.
As shown above, just add <code class="docutils literal notranslate"><span class="pre">openmpi</span></code>/<code class="docutils literal notranslate"><span class="pre">mpich</span></code> to the <code class="docutils literal notranslate"><span class="pre">requirements/host</span></code> section and use compiler directives for the
corresponding compilers in <code class="docutils literal notranslate"><span class="pre">requirements/build</span></code> as normal.</p>
</section>
</section>
<section id="openmp">
<h3>OpenMP<a class="headerlink" href="#openmp" title="Permalink to this heading">¶</a></h3>
<p>You can enable OpenMP on macOS by adding the <code class="docutils literal notranslate"><span class="pre">llvm-openmp</span></code> package to the <code class="docutils literal notranslate"><span class="pre">build</span></code> section of the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code>.
For Linux OpenMP support is on by default, however it’s better to explicitly depend on the <cite>libgomp</cite> package which is the OpenMP
implementation from the GNU project.</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># meta.yaml</span>
<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llvm-openmp</span><span class="w">  </span><span class="c1"># [osx]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libgomp</span><span class="w">      </span><span class="c1"># [linux]</span>
</pre></div>
</div>
</div></blockquote>
<section id="switching-openmp-implementation">
<h4>Switching OpenMP implementation<a class="headerlink" href="#switching-openmp-implementation" title="Permalink to this heading">¶</a></h4>
<p>On macOS, only LLVM’s OpenMP implementation <code class="docutils literal notranslate"><span class="pre">llvm-openmp</span></code> is supported. This implementation is used even in Fortran code compiled
using GNU’s gfortran.</p>
<p>On Linux (except aarch64), packages are linked against GNU’s <code class="docutils literal notranslate"><span class="pre">libgomp.so.1</span></code>, but the OpenMP library at install time can be
switched from GNU to LLVM by doing the following.</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span><span class="nv">_openmp_mutex</span><span class="o">=</span>*<span class="o">=</span>*_llvm
</pre></div>
</div>
</div></blockquote>
<p>OpenMP library can be switched back to GNU’s libgomp by doing the following.</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span><span class="nv">_openmp_mutex</span><span class="o">=</span>*<span class="o">=</span>*_gnu
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>OpenMP library switching is possible because LLVM’s implementation has the symbol’s from GNU in addition to the LLVM
ones (originally from Intel). An object file generated by <code class="docutils literal notranslate"><span class="pre">gcc</span></code>, <code class="docutils literal notranslate"><span class="pre">g++</span></code> or <code class="docutils literal notranslate"><span class="pre">gfortran</span></code> will have GNU’s symbols and
therefore the underlying library can be switched.
However, an object file generated by <code class="docutils literal notranslate"><span class="pre">clang</span></code> or <code class="docutils literal notranslate"><span class="pre">clang++</span></code> will have LLVM’s symbols and therefore the underlying
OpenMP library cannot be switched to GNU’s library.</p>
<p>One reason you may wish to switch to LLVM is because the implementation is fork safe. One reason to keep using the
GNU implementation is that the OpenMP target offloading symbols in <code class="docutils literal notranslate"><span class="pre">libgomp</span></code> like <code class="docutils literal notranslate"><span class="pre">GOMP_target</span></code> are empty stubs
in LLVM and therefore does not work.</p>
</div>
</section>
</section>
<section id="yum-requirements-txt">
<span id="yum-deps"></span><h3>yum_requirements.txt<a class="headerlink" href="#yum-requirements-txt" title="Permalink to this heading">¶</a></h3>
<p>Dependencies can be installed into the build container with <code class="docutils literal notranslate"><span class="pre">yum</span></code>, by listing package names line by line in a file
named <code class="docutils literal notranslate"><span class="pre">yum_requirements.txt</span></code> in the <code class="docutils literal notranslate"><span class="pre">recipe</span></code> directory of a feedstock.</p>
<p>There are only very few situations where dependencies installed by yum are acceptable. These cases include</p>
<blockquote>
<div><ul class="simple">
<li><p>satisfying the requirements of <a class="reference internal" href="../misc/00_intro.html#term-CDT"><span class="xref std std-term">CDT</span></a> packages during test phase</p></li>
<li><p>installing packages that are only required for testing</p></li>
</ul>
</div></blockquote>
<p>After changing <code class="docutils literal notranslate"><span class="pre">yum_requirements.txt</span></code>, <a class="reference internal" href="updating_pkgs.html#dev-update-rerender"><span class="std std-ref">rerender</span></a> to update the configuration.</p>
</section>
<section id="blas">
<span id="knowledge-blas"></span><h3>BLAS<a class="headerlink" href="#blas" title="Permalink to this heading">¶</a></h3>
<p>If a package needs one of BLAS, CBLAS, LAPACK, LAPACKE, use the following in the
host of the recipe,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libblas</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libcblas</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">liblapack</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">liblapacke</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You should specify only the libraries that the package needs. (i.e. if the package
doesn’t need LAPACK, remove liblapack and liblapacke)</p>
<p>At recipe build time, above requirements would download the NETLIB’s reference
implementations and build your recipe against those.
At runtime, by default the following packages will be used.</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openblas</span><span class="w">   </span><span class="c1"># [not win]</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkl</span><span class="w">        </span><span class="c1"># [win]</span>
</pre></div>
</div>
<p>If a package needs a specific implementation’s internal API for more control you can have,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">blas_impl</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libblas * *{{ blas_impl }}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">blas_impl</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>This would give you a matrix builds for different blas implementations. If you only want to support
a specific blas implementation,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openblas</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">libblas * *openblas</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openblas</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">blas_*</span></code> features should not be used anymore.</p>
</div>
<section id="switching-blas-implementation">
<h4>Switching BLAS implementation<a class="headerlink" href="#switching-blas-implementation" title="Permalink to this heading">¶</a></h4>
<p>You can switch your BLAS implementation by doing,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;libblas=*=*mkl&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;libblas=*=*openblas&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;libblas=*=*blis&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;libblas=*=*accelerate&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;libblas=*=*netlib&quot;</span>
</pre></div>
</div>
<p>This would change the BLAS implementation without changing the conda packages depending
on BLAS.</p>
<p>The following legacy commands are also supported as well.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;blas=*=mkl&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;blas=*=openblas&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;blas=*=blis&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;blas=*=accelerate&quot;</span>
conda<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;blas=*=netlib&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to commit to a specific blas implementation, you can prevent conda from switching back by pinning
the blas implementation in your environment. To commit to mkl, add <code class="docutils literal notranslate"><span class="pre">blas=*=mkl</span></code> to
<code class="docutils literal notranslate"><span class="pre">&lt;conda-root&gt;/envs/&lt;env-name&gt;/conda-meta/pinned</span></code>, as described in the
<a class="reference external" href="https://docs.conda.io/projects/conda/en/stable/user-guide/tasks/manage-pkgs.html#preventing-packages-from-updating-pinning">conda-docs</a>.</p>
</div>
</section>
<section id="how-it-works">
<h4>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this heading">¶</a></h4>
<p>At recipe build time, the netlib packages are used. This means that the downstream package will
link to <code class="docutils literal notranslate"><span class="pre">libblas.so.3</span></code> in the <code class="docutils literal notranslate"><span class="pre">libblas=*=*netlib</span></code> and will use only the reference
implementation’s symbols.</p>
<p><code class="docutils literal notranslate"><span class="pre">libblas</span></code> and <code class="docutils literal notranslate"><span class="pre">libcblas</span></code> versioning is based on the Reference LAPACK versioning which at the
time of writing is <code class="docutils literal notranslate"><span class="pre">3.8.0</span></code>. Since the BLAS API is stable, a downstream package will only pin to
<code class="docutils literal notranslate"><span class="pre">3.*</span></code> of <code class="docutils literal notranslate"><span class="pre">libblas</span></code> and <code class="docutils literal notranslate"><span class="pre">libcblas</span></code>. On the other hand, <code class="docutils literal notranslate"><span class="pre">liblapack</span></code> and <code class="docutils literal notranslate"><span class="pre">liblapacke</span></code> pins to
<code class="docutils literal notranslate"><span class="pre">3.8.*</span></code>.</p>
<p>In addition to the above netlib package, there are other variants like <code class="docutils literal notranslate"><span class="pre">libblas=*=*openblas</span></code>,
which has <code class="docutils literal notranslate"><span class="pre">openblas</span></code> as a dependency and has a symlink from <code class="docutils literal notranslate"><span class="pre">libblas.so.3</span></code> to <code class="docutils literal notranslate"><span class="pre">libopenblas.so</span></code>.
<code class="docutils literal notranslate"><span class="pre">libblas=3.8.0=*openblas</span></code> pins the <code class="docutils literal notranslate"><span class="pre">openblas</span></code> dependency to a version that is known to support the
BLAS <code class="docutils literal notranslate"><span class="pre">3.8.0</span></code> API.  This means that, at install time, the user can select what BLAS implementation
they like without any knowledge of the version of the BLAS implementation needed.</p>
</section>
</section>
<section id="matplotlib">
<span id="knowledge-mpl"></span><h3>Matplotlib<a class="headerlink" href="#matplotlib" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> on <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> comes in two parts. The core library is in <code class="docutils literal notranslate"><span class="pre">matplotlib-base</span></code>. The
actual <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> package is this core library plus <code class="docutils literal notranslate"><span class="pre">pyqt</span></code>. Most, if not all, packages that have
dependence at runtime on <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> should list this dependence as <code class="docutils literal notranslate"><span class="pre">matplotlib-base</span></code> unless they
explicitly need <code class="docutils literal notranslate"><span class="pre">pyqt</span></code>. The idea is that a user installing <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> explicitly would get a full
featured installation with <code class="docutils literal notranslate"><span class="pre">pyqt</span></code>. However, <code class="docutils literal notranslate"><span class="pre">pyqt</span></code> is a rather large package, so not requiring it
indirectly is better for performance. Note that you may need to include a <code class="docutils literal notranslate"><span class="pre">yum_requirements.txt</span></code> file
in your recipe with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xorg-x11-server-Xorg
</pre></div>
</div>
<p>if you import parts of <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> that link to <code class="docutils literal notranslate"><span class="pre">libX11</span></code>.</p>
</section>
<section id="pybind11-abi-constraints">
<h3><code class="docutils literal notranslate"><span class="pre">pybind11</span></code> ABI Constraints<a class="headerlink" href="#pybind11-abi-constraints" title="Permalink to this heading">¶</a></h3>
<p>Sometimes when different python libraries using <code class="docutils literal notranslate"><span class="pre">pybind11</span></code> interact via lower-level C++ interfaces,
the underlying ABI between the two libraries has to match. To ease this use case, we have a <code class="docutils literal notranslate"><span class="pre">pybind11-abi</span></code>
metapackage that can be used in the <code class="docutils literal notranslate"><span class="pre">host</span></code> section of a build. Its version is pinned globally and it has a
run export on itself, meaning that builds with this package in <code class="docutils literal notranslate"><span class="pre">host</span></code> will have a runtime constraint on it.
Further, the <code class="docutils literal notranslate"><span class="pre">pybind11</span></code> has a run constraint on the ABI metapackage to help ensure consistent usage.</p>
<p>To use this package in a build, put it in the host environment like so</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pybind11-abi</span>
</pre></div>
</div>
</section>
<section id="empty-python-packages">
<span id="knowledge-empty"></span><h3>Empty Python packages<a class="headerlink" href="#empty-python-packages" title="Permalink to this heading">¶</a></h3>
<p>For some features introduced in later Python versions, the Python community creates backports, which makes these
features available for earlier versions of Python as well.
One example here is <a class="reference external" href="https://www.python.org/dev/peps/pep-0557/">dataclasses</a> which was introduced with
Python3.7 but is available as a <a class="reference external" href="https://github.com/ericvsmith/dataclasses">backport</a> for Python3.6 too.
Therefore, most upstream packages make those backports only mandatory for specific versions of Python and exclude them otherwise.</p>
<p>Implementing this restriction in conda-forge is currently only possible through the use of <code class="docutils literal notranslate"><span class="pre">skips</span></code>
which restricts the corresponding conda-forge recipes from becoming <code class="docutils literal notranslate"><span class="pre">noarch</span></code>.</p>
<p>Therefore, some conda-forge recipes only create an actual package on specific Python versions and are otherwise an
empty placeholder. This allows them to be safely installed under all Python versions and makes using <code class="docutils literal notranslate"><span class="pre">skips</span></code> unnecessary.</p>
<p>Similarly, some packages are <cite>only</cite> platform-specific dependency of a package, such as <code class="docutils literal notranslate"><span class="pre">pywin32</span></code>, and have
helper metapackages which can help recipes stay <code class="docutils literal notranslate"><span class="pre">noarch</span></code>. The version of the <cite>actual</cite> package required
can be controlled with <code class="docutils literal notranslate"><span class="pre">run_constrained</span></code>, even for packages not available on all platforms.</p>
<p>Currently available packages:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Available on:</p></th>
<th class="head"><p>Empty on:</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dataclasses</p></td>
<td><p>python &gt;=3.6,&lt;3.7</p></td>
<td><p>python &gt;=3.7</p></td>
</tr>
<tr class="row-odd"><td><p>enum34</p></td>
<td><p>python =2.7</p></td>
<td><p>python &gt;=3.4</p></td>
</tr>
<tr class="row-even"><td><p>typing</p></td>
<td></td>
<td><p>python &gt;=3</p></td>
</tr>
<tr class="row-odd"><td><p>pywin32-on-windows</p></td>
<td><p>windows</p></td>
<td><p>unix</p></td>
</tr>
</tbody>
</table>
</section>
<section id="non-version-specific-python-packages">
<span id="knowledge-all-installs"></span><h3>Non-version-specific Python packages<a class="headerlink" href="#non-version-specific-python-packages" title="Permalink to this heading">¶</a></h3>
<p>For some dependencies, upstream maintainers list Python versions where those packages are needed,
even if the packages can actually be installed under all Python versions.</p>
<p>Implementing this restriction in conda-forge is currently only possible through the use of <code class="docutils literal notranslate"><span class="pre">skips</span></code>
which restricts the corresponding conda-forge recipes from becoming <code class="docutils literal notranslate"><span class="pre">noarch</span></code>.</p>
<p>Therefore, the conda-forge community maintains a list of packages that are safe to be installed under all Python versions,
even if the original package only requires it for some versions.</p>
<p>For example, the package <a class="reference external" href="https://github.com/rigetti/pyquil">pyquil</a> only
<a class="reference external" href="https://github.com/rigetti/pyquil/blob/497791e8108d8780109d75410be786c5f6e590ea/pyproject.toml#L30">requires</a> <code class="docutils literal notranslate"><span class="pre">importlib-metadata</span></code> for <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">&lt;3.8</span></code> but it is actually save to be installed under <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">&gt;=3.8</span></code> as well.</p>
<p>Currently available packages:</p>
<blockquote>
<div><ul class="simple">
<li><p>exceptiongroup</p></li>
<li><p>importlib-metadata</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="noarch-builds">
<h2>Noarch builds<a class="headerlink" href="#noarch-builds" title="Permalink to this heading">¶</a></h2>
<p>Noarch packages are packages that are not architecture specific and therefore only have to be built once.</p>
<p>Declaring these packages as <code class="docutils literal notranslate"><span class="pre">noarch</span></code> in the <code class="docutils literal notranslate"><span class="pre">build</span></code> section of the meta.yaml, reduces shared CI resources.
Therefore all packages that qualify to be noarch packages <cite>should</cite> be declared as such.</p>
<section id="noarch-python">
<span id="noarch"></span><h3>Noarch python<a class="headerlink" href="#noarch-python" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">noarch:</span> <span class="pre">python</span></code> directive, in the <code class="docutils literal notranslate"><span class="pre">build</span></code> section, makes pure-Python
packages that only need to be built once.</p>
<p>In order to qualify as a noarch python package, all of the following criteria must be fulfilled:</p>
<blockquote>
<div><ul class="simple">
<li><p>No compiled extensions</p></li>
<li><p>No post-link or pre-link or pre-unlink scripts</p></li>
<li><p>No OS-specific build scripts</p></li>
<li><p>No python version specific requirements</p></li>
<li><p>No skips except for python version. If the recipe is py3 only, remove skip
statement and add version constraint on python in <code class="docutils literal notranslate"><span class="pre">host</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code>
section.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2to3</span></code> is not used</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scripts</span></code> argument in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> is not used</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">console_scripts</span></code> <code class="docutils literal notranslate"><span class="pre">entry_points</span></code> are defined in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> or <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code>, they are also
<a class="reference external" href="https://conda.io/projects/conda-build/en/stable/resources/define-metadata.html#python-entry-points">listed</a>
in the <code class="docutils literal notranslate"><span class="pre">build</span></code> section of <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code></p></li>
<li><p>No activate scripts</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While <code class="docutils literal notranslate"><span class="pre">noarch:</span> <span class="pre">python</span></code> does not work with selectors, it does work with version constraints.
<code class="docutils literal notranslate"><span class="pre">skip:</span> <span class="pre">True</span>&#160; <span class="pre">#</span> <span class="pre">[py2k]</span></code> can be replaced with a constrained python version in the host and run subsections:
say <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">&gt;=3</span></code> instead of just <code class="docutils literal notranslate"><span class="pre">python</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only <code class="docutils literal notranslate"><span class="pre">console_scripts</span></code> entry points have to be listed in <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code>. Other entry points do not conflict
with <code class="docutils literal notranslate"><span class="pre">noarch</span></code> and therefore do not require extra treatment.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">noarch</span></code> is a statement about the package’s source code and not its install environment. A package is still considered
<code class="docutils literal notranslate"><span class="pre">noarch</span></code> even if one of its dependencies is not available on a given platform. If this is the case, conda will
display a helpful error message describing which dependency couldn’t be found when it tries to install the package.
If the dependency is later made available, your package will be installable on that platform without having to make
any changes to the feedstock.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">noarch</span></code> packages are built on Linux, and all dependencies must be available on Linux.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">noarch</span></code> package <cite>cannot</cite> be built on Linux, one or more <code class="docutils literal notranslate"><span class="pre">noarch_platforms</span></code> can be provided in
<code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code>. One example is <a class="reference external" href="https://github.com/conda-forge/pywin32-on-windows-feedstock">pywin32-on-windows</a>,
which builds on Linux <cite>and</cite> Windows, with <code class="docutils literal notranslate"><span class="pre">build_number</span></code> offsets to create a pair packages, like
<code class="docutils literal notranslate"><span class="pre">dataclasses</span></code>.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can build platform-specific <code class="docutils literal notranslate"><span class="pre">noarch</span></code> packages to include runtime requirements depending on the target OS.
See mini-tutorial below.</p>
</div>
<p>If an existing python package qualifies to be converted to a noarch package, you can request the required changes
by opening a new issue and including <code class="docutils literal notranslate"><span class="pre">&#64;conda-forge-admin,</span> <span class="pre">please</span> <span class="pre">add</span> <span class="pre">noarch:</span> <span class="pre">python</span></code>.</p>
<section id="noarch-packages-with-os-specific-dependencies">
<span id="os-specific-noarch"></span><h4>Noarch packages with OS-specific dependencies<a class="headerlink" href="#noarch-packages-with-os-specific-dependencies" title="Permalink to this heading">¶</a></h4>
<p>It is possible to build <code class="docutils literal notranslate"><span class="pre">noarch</span></code> packages with runtime requirements that depend on the target OS
(Linux, Windows, MacOS), regardless the architecture (amd64, ARM, PowerPC, etc). This approach
relies on three concepts:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-virtual.html">Virtual packages</a>.
Prefixed with a double underscore, they are used by conda to represent system properties as
constraints for the solver at install-time. We will use <code class="docutils literal notranslate"><span class="pre">__linux</span></code>, <code class="docutils literal notranslate"><span class="pre">__win</span></code> or <code class="docutils literal notranslate"><span class="pre">__osx</span></code>,
which are only present when the running platform is Linux, Windows, or MacOS, respectively.
<code class="docutils literal notranslate"><span class="pre">__unix</span></code> is present in both Linux and MacOS. Note that this feature is <strong>only fully available
on conda 4.10 or above</strong>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code>’s <a class="reference internal" href="conda_forge_yml.html#noarch-platforms"><span class="std std-ref">noarch_platforms</span></a> option.</p></li>
<li><p><strong>conda-build 3.25.0 or above</strong> changing the build hash depending on virtual packages used.</p></li>
</ol>
<p>The idea is to generate different noarch packages for each OS needing different dependencies.
Let’s say you have a pure Python package, perfectly eligible for <code class="docutils literal notranslate"><span class="pre">noarch:</span> <span class="pre">python</span></code>, but on Windows
it requires <code class="docutils literal notranslate"><span class="pre">windows-only-dependency</span></code>. You might have something like:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">recipe/meta.yaml (original)</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="nt">source</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">windows-only-dependency</span><span class="w">  </span><span class="c1"># [win]</span>
</pre></div>
</div>
</div>
<p>Being non-noarch, this means that the build matrix will include at least 12 outputs: three platforms,
times four Python versions. This gets worse with <code class="docutils literal notranslate"><span class="pre">arm64</span></code>, <code class="docutils literal notranslate"><span class="pre">aarch64</span></code> and <code class="docutils literal notranslate"><span class="pre">ppc64le</span></code> in the mix.
We can get it down to two outputs if replace it with this other approach!</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">recipe/meta.yaml (modified)</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="nt">source</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">  </span><span class="nt">noarch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python &gt;=3.7</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python &gt;=3.7</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__unix</span><span class="w">  </span><span class="c1"># [unix]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__win</span><span class="w">   </span><span class="c1"># [win]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">windows-only-dependency</span><span class="w">  </span><span class="c1"># [win]</span>
</pre></div>
</div>
</div>
<p>Do not forget to specify the platform virtual packages with their selectors!
Otherwise, the solver will not be able to choose the variants correctly.</p>
<p>By default, conda-forge will only build <code class="docutils literal notranslate"><span class="pre">noarch</span></code> packages on a <code class="docutils literal notranslate"><span class="pre">linux_64</span></code> CI runner, so
only the <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">[unix]</span></code> selectors would be true. However, we can change this behaviour using
the <code class="docutils literal notranslate"><span class="pre">noarch_platforms</span></code> option in <code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">conda-forge.yml</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">noarch_platforms</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux_64</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">win_64</span>
</pre></div>
</div>
</div>
<p>This will provide two runners per package! Perfect! All these changes require a
feedstock rerender to be applied. See <a class="reference internal" href="updating_pkgs.html#dev-update-rerender"><span class="std std-ref">Rerendering feedstocks</span></a>.</p>
<p>If you need conditional dependencies on all three operating systems, this is how you do it:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">recipe/meta.yaml</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
<span class="nt">source</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">  </span><span class="nt">noarch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__linux</span><span class="w">  </span><span class="c1"># [linux]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__osx</span><span class="w">    </span><span class="c1"># [osx]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__win</span><span class="w">    </span><span class="c1"># [win]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux-only-dependency</span><span class="w">    </span><span class="c1"># [linux]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osx-only-dependency</span><span class="w">      </span><span class="c1"># [osx]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">windows-only-dependency</span><span class="w">  </span><span class="c1"># [win]</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">conda-forge.yml</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">noarch_platforms</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux_64</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osx_64</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">win_64</span>
</pre></div>
</div>
</div>
<p>Again, remember to rerender after adding / modifying these files so the changes are applied.</p>
</section>
</section>
<section id="noarch-generic">
<h3>Noarch generic<a class="headerlink" href="#noarch-generic" title="Permalink to this heading">¶</a></h3>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>add some information on r packages which make heavy use of <code class="docutils literal notranslate"><span class="pre">noarch:</span> <span class="pre">generic</span></code></p>
</div>
</section>
</section>
<section id="build-matrices">
<h2>Build matrices<a class="headerlink" href="#build-matrices" title="Permalink to this heading">¶</a></h2>
<p>Currently, <code class="docutils literal notranslate"><span class="pre">python,</span> <span class="pre">vc,</span> <span class="pre">r-base</span></code> will create a matrix of jobs for each supported version. If <code class="docutils literal notranslate"><span class="pre">python</span></code> is only a
build dependency and not a runtime dependency (eg: build script of the package is written in Python, but the
package is not dependent on Python), use <code class="docutils literal notranslate"><span class="pre">build</span></code> section</p>
<p>Following implies that <code class="docutils literal notranslate"><span class="pre">python</span></code> is only a build dependency and no Python matrix will be created.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">host</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">some_other_package</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">host</span></code> should be non-empty or <code class="docutils literal notranslate"><span class="pre">compiler</span></code> jinja syntax used or <code class="docutils literal notranslate"><span class="pre">build/merge_build_host</span></code> set to
True for the <code class="docutils literal notranslate"><span class="pre">build</span></code> section to be treated as different from <code class="docutils literal notranslate"><span class="pre">host</span></code>.</p>
<p>Following implies that <code class="docutils literal notranslate"><span class="pre">python</span></code> is a runtime dependency and a Python matrix for each supported Python version will be created.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">host</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code>’s build matrices is removed in conda-smithy=3. To get a build matrix,
create a <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file inside the recipe folder. For example, the following will give you 2
builds and you can use the selector <code class="docutils literal notranslate"><span class="pre">vtk_with_osmesa</span></code> in the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vtk_with_osmesa</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</pre></div>
</div>
<p>You need to rerender the feedstock after this change.</p>
</section>
<section id="requiring-newer-macos-sdks">
<h2>Requiring newer macOS SDKs<a class="headerlink" href="#requiring-newer-macos-sdks" title="Permalink to this heading">¶</a></h2>
<p>conda-forge uses macOS SDK 10.9 to build software so that they can be deployed to
all macOS versions newer than 10.9. Sometimes, some packages require a newer SDK
to build with. While the default version 10.9 can be overridden using the following
changes to the recipe, it should be done as a last resort. Please consult with
core team if this is something you think you need.</p>
<p>To use a new SDK, add the following in <code class="docutils literal notranslate"><span class="pre">recipe/conda_build_config.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Please consult conda-forge/core before doing this</span>
<span class="nt">MACOSX_SDK_VERSION</span><span class="p">:</span><span class="w">        </span><span class="c1"># [osx and x86_64]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;10.12&quot;</span><span class="w">                </span><span class="c1"># [osx and x86_64]</span>
</pre></div>
</div>
<p>Note that this should be done if the error you are getting says that a header is not
found or a macro is not defined. This will make your package compile with a newer SDK
but with <code class="docutils literal notranslate"><span class="pre">10.9</span></code> as the deployment target.
WARNING: some packages might use features from <code class="docutils literal notranslate"><span class="pre">10.12</span></code> if you do the above due to
buggy symbol availability checks. For example packages looking for <code class="docutils literal notranslate"><span class="pre">clock_gettime</span></code>
will see it as it will be a weak symbol, but the package might not have a codepath
to handle the weak symbol, in that case, you need to update the <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET</span></code>
as described below.</p>
<p>After increasing the SDK version, if you are getting an error that says that a function
is available only for macOS x.x, then do the following in <code class="docutils literal notranslate"><span class="pre">recipe/conda_build_config.yaml</span></code>,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Please consult conda-forge/core before doing this</span>
<span class="nt">MACOSX_DEPLOYMENT_TARGET</span><span class="p">:</span><span class="w">  </span><span class="c1"># [osx and x86_64]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;10.12&quot;</span><span class="w">                </span><span class="c1"># [osx and x86_64]</span>
<span class="nt">MACOSX_SDK_VERSION</span><span class="p">:</span><span class="w">        </span><span class="c1"># [osx and x86_64]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;10.12&quot;</span><span class="w">                </span><span class="c1"># [osx and x86_64]</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">recipe/meta.yaml</span></code>, add the following to ensure that the user’s system is compatible.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__osx &gt;={{ MACOSX_DEPLOYMENT_TARGET|default(&quot;10.9&quot;) }}</span><span class="w">  </span><span class="c1"># [osx and x86_64]</span>
</pre></div>
</div>
<p>Note that this requires <code class="docutils literal notranslate"><span class="pre">conda&gt;=4.8</span></code>. If you want to support older conda versions
the requirement should be changed from <code class="docutils literal notranslate"><span class="pre">run</span></code> to <code class="docutils literal notranslate"><span class="pre">run_constrained</span></code>. Note that
<code class="docutils literal notranslate"><span class="pre">conda&lt;4.8</span></code> will ignore the condition if it’s a <code class="docutils literal notranslate"><span class="pre">run_constrained</span></code> on <code class="docutils literal notranslate"><span class="pre">__osx</span></code>.</p>
<section id="newer-c-features-with-old-sdk">
<h3>Newer C++ features with old SDK<a class="headerlink" href="#newer-c-features-with-old-sdk" title="Permalink to this heading">¶</a></h3>
<p>The libc++ library uses Clang availability annotations to mark certain symbols as
unavailable when targeting versions of macOS that ship with a system libc++
that do not contain them. Clang always assumes that the system libc++ is used.</p>
<p>The conda-forge build infrastructure targets macOS 10.9 and some newer C++ features
such as <code class="docutils literal notranslate"><span class="pre">fs::path</span></code> are marked as unavailable on that platform, so the build aborts:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>...
error:<span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="w"> </span>is<span class="w"> </span>unavailable:<span class="w"> </span>introduced<span class="w"> </span><span class="k">in</span><span class="w"> </span>macOS<span class="w"> </span><span class="m">10</span>.15
...
note:<span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="w"> </span>has<span class="w"> </span>been<span class="w"> </span>explicitly<span class="w"> </span>marked<span class="w"> </span>unavailable<span class="w"> </span>here
class<span class="w"> </span>_LIBCPP_TYPE_VIS<span class="w"> </span>path<span class="w"> </span><span class="o">{</span>
</pre></div>
</div>
<p>However, since conda-forge ships its own (modern) libcxx we can ignore these checks
because these symbols are in fact available. To do so, add
<code class="docutils literal notranslate"><span class="pre">_LIBCPP_DISABLE_AVAILABILITY</span></code> to the defines. For example</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">CXXFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CXXFLAGS</span><span class="si">}</span><span class="s2"> -D_LIBCPP_DISABLE_AVAILABILITY&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="pypy-builds">
<h2>PyPy builds<a class="headerlink" href="#pypy-builds" title="Permalink to this heading">¶</a></h2>
<p>See <a class="reference internal" href="../user/tipsandtricks.html#pypy"><span class="std std-ref">Using PyPy as an interpreter</span></a> in the user docs for more info about PyPy and <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code>.</p>
<p>To build your python package for pypy, wait for the bot to send a
PR and contact <code class="docutils literal notranslate"><span class="pre">conda-forge/bot</span></code> team if a PR is not sent after the
dependencies have been built.</p>
<p>To add a dependency just for pypy or cpython, do,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spam</span><span class="w">           </span><span class="c1"># [python_impl == &#39;cpython&#39;]</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ham</span><span class="w">            </span><span class="c1"># [python_impl == &#39;pypy&#39;]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You’ll need to rerender the feedstocks after making the above
change in order for the <code class="docutils literal notranslate"><span class="pre">python_impl</span></code> variable to be available to
conda-build</p>
</div>
<p>To skip the pypy builds, do the following,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">         </span><span class="c1"># [python_impl == &#39;pypy&#39;]</span>
</pre></div>
</div>
<p>If something is failing the PyPy build when it passes the CPython one, reach
out to &#64;conda-forge/help-pypy.</p>
</section>
<section id="using-setuptools-scm">
<h2>Using setuptools_scm<a class="headerlink" href="#using-setuptools-scm" title="Permalink to this heading">¶</a></h2>
<p>The Python module <a class="reference external" href="https://github.com/pypa/setuptools_scm">setuptools_scm</a>
can be used to manage a package’s version automatically from metadata, such as git tags.
The package’s version string is thus not specified anywhere in the package,
but encoded in it at install-time.</p>
<p>For conda-build this means that <code class="docutils literal notranslate"><span class="pre">setuptools_scm</span></code> must be included as a <code class="docutils literal notranslate"><span class="pre">host</span></code> dependency.
Additionally, some attention because the metadata is often not available in the sources.
There are two options for how to proceed:</p>
<ul>
<li><p>For Python package also available on PyPI:
Use the PyPi tarball as a source, as it will have the metadata encoded
(in such a way that <code class="docutils literal notranslate"><span class="pre">setuptools_scm</span></code> knows how to find it).</p></li>
<li><p>Specify the environment variable <code class="docutils literal notranslate"><span class="pre">SETUPTOOLS_SCM_PRETEND_VERSION</span></code> with the version string.
If specified this environment variable is the principle source for <code class="docutils literal notranslate"><span class="pre">setuptools_scm</span></code>.
There are two ways how to do this:</p>
<ul>
<li><p>If you are using build scripts, in <code class="docutils literal notranslate"><span class="pre">build.sh</span></code> specify:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">SETUPTOOLS_SCM_PRETEND_VERSION</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PKG_VERSION</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>and in <code class="docutils literal notranslate"><span class="pre">bld.bat</span></code> specify:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="w"> </span><span class="nv">SETUPTOOLS_SCM_PRETEND_VERSION</span><span class="o">=</span>%PKG_VERSION%
</pre></div>
</div>
<p>Whereby you use that <code class="docutils literal notranslate"><span class="pre">PKG_VERSION</span></code> has been set with the version string,
see <a class="reference external" href="https://docs.conda.io/projects/conda-build/en/stable/user-guide/environment-variables.html#env-vars">Environment variables</a>.</p>
</li>
<li><p>Otherwise, if you are directly building from <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code>, use for example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">build</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># [...]</span>
<span class="w">  </span><span class="nt">script_env</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SETUPTOOLS_SCM_PRETEND_VERSION={{version}}</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">PYTHON</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-m</span><span class="nv"> </span><span class="s">pip</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">.</span><span class="nv"> </span><span class="s">-vv&quot;</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="using-centos-7">
<span id="centos7"></span><h2>Using CentOS 7<a class="headerlink" href="#using-centos-7" title="Permalink to this heading">¶</a></h2>
<p>To use the newer CentOS 7 <code class="docutils literal notranslate"><span class="pre">sysroot</span></code> with <code class="docutils literal notranslate"><span class="pre">glibc</span></code> <code class="docutils literal notranslate"><span class="pre">2.17</span></code> on <code class="docutils literal notranslate"><span class="pre">linux-64</span></code>,
put the following in your build section.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requirements</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">compiler(&#39;c&#39;)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sysroot_linux-64 2.17</span><span class="w">  </span><span class="c1"># [linux64]</span>
</pre></div>
</div>
<p>You also need to use a newer docker image by setting the following in the <code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code>
of your recipe and rerendering.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">os_version</span><span class="p">:</span>
<span class="w">  </span><span class="nt">linux_64</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cos7</span>
</pre></div>
</div>
<p>Finally, note that the <code class="docutils literal notranslate"><span class="pre">aarch64</span></code> and <code class="docutils literal notranslate"><span class="pre">ppc64le</span></code> platforms already use CentOS 7.</p>
</section>
<section id="cuda-builds">
<span id="cuda"></span><h2>CUDA builds<a class="headerlink" href="#cuda-builds" title="Permalink to this heading">¶</a></h2>
<p>Although the provisioned CI machines do not feature a GPU, Conda-Forge does provide mechanisms
to build CUDA-enabled packages. These mechanisms involve several packages:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cudatoolkit</span></code>: The runtime libraries for the CUDA toolkit. This is what end-users will end
up installing next to your package.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nvcc</span></code>: Nvidia’s EULA does not allow the redistribution of compilers and drivers. Instead, we
provide a wrapper package that locates the CUDA installation in the system. The main role of this
package is to set some environment variables (<code class="docutils literal notranslate"><span class="pre">CUDA_HOME</span></code>, <code class="docutils literal notranslate"><span class="pre">CUDA_PATH</span></code>, <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> and others),
as well as wrapping the real <code class="docutils literal notranslate"><span class="pre">nvcc</span></code> executable to set some extra command line arguments.</p></li>
</ul>
<p>In practice, to enable CUDA on your package, add <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">compiler('cuda')</span> <span class="pre">}}</span></code> to the <code class="docutils literal notranslate"><span class="pre">build</span></code>
section of your requirements and rerender. The matching <code class="docutils literal notranslate"><span class="pre">cudatoolkit</span></code> will be added to the <code class="docutils literal notranslate"><span class="pre">run</span></code>
requirements automatically.</p>
<p>On Linux, CMake users are required to use <code class="docutils literal notranslate"><span class="pre">${CMAKE_ARGS}</span></code> so CMake can find CUDA correctly. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir build &amp;&amp; cd build
cmake ${CMAKE_ARGS} ${SRC_DIR}
make
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>How is CUDA provided at the system level?</strong></p>
<ul class="simple">
<li><p>On Linux, Nvidia provides official Docker images, which we then
<a class="reference external" href="https://github.com/conda-forge/docker-images">adapt</a> to Conda-Forge’s needs.</p></li>
<li><p>On Windows, the compilers need to be installed for every CI run. This is done through the
<a class="reference external" href="https://github.com/conda-forge/conda-forge-ci-setup-feedstock/">conda-forge-ci-setup</a> scripts.
Do note that the Nvidia executable won’t install the drivers because no GPU is present in the machine.</p></li>
</ul>
<p><strong>How is cudatoolkit selected at install time?</strong></p>
<p>Conda exposes the maximum CUDA version supported by the installed Nvidia drivers through a virtual package
named <code class="docutils literal notranslate"><span class="pre">__cuda</span></code>. By default, <code class="docutils literal notranslate"><span class="pre">conda</span></code> will install the highest version available
for the packages involved. To override this behaviour, you can define a <code class="docutils literal notranslate"><span class="pre">CONDA_OVERRIDE_CUDA</span></code> environment
variable. More details in the
<a class="reference external" href="https://docs.conda.io/projects/conda/en/stable/user-guide/tasks/manage-virtual.html#overriding-detected-packages">Conda docs</a>.</p>
<p>Note that prior to v4.8.4, <code class="docutils literal notranslate"><span class="pre">__cuda</span></code> versions would not be part of the constraints, so you would always
get the latest one, regardless the supported CUDA version.</p>
<p>If for some reason you want to install a specific version, you can use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="n">your</span><span class="o">-</span><span class="n">gpu</span><span class="o">-</span><span class="n">package</span> <span class="n">cudatoolkit</span><span class="o">=</span><span class="mf">10.1</span>
</pre></div>
</div>
</div>
<section id="testing-the-packages">
<h3>Testing the packages<a class="headerlink" href="#testing-the-packages" title="Permalink to this heading">¶</a></h3>
<p>Since the CI machines do not feature a GPU, you won’t be able to test the built packages as part
of the conda recipe. That does not mean you can’t test your package locally. To do so:</p>
<ol class="arabic">
<li><p>Enable the Azure artifacts for your feedstock (see <a class="reference internal" href="conda_forge_yml.html#azure-config"><span class="std std-ref">here</span></a>).</p></li>
<li><p>Include the test files and requirements in the recipe
<a class="reference external" href="https://github.com/conda-forge/cupy-feedstock/blob/a1e9cdf47775f90d3153a26913068c6df942d54b/recipe/meta.yaml#L51-L61">like this</a>.</p></li>
<li><p>Provide the test instructions. Take into account that the GPU tests will fail in the CI run,
so you need to ignore them to get the package built and uploaded as an artifact.
<a class="reference external" href="https://github.com/conda-forge/cupy-feedstock/blob/a1e9cdf47775f90d3153a26913068c6df942d54b/recipe/run_test.py">Example</a>.</p></li>
<li><p>Once you have downloaded the artifacts, you will be able to run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">build</span> <span class="o">--</span><span class="n">test</span> <span class="o">&lt;</span><span class="n">pkg</span> <span class="n">file</span><span class="o">&gt;.</span><span class="n">tar</span><span class="o">.</span><span class="n">bz2</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="common-problems-and-known-issues">
<h3>Common problems and known issues<a class="headerlink" href="#common-problems-and-known-issues" title="Permalink to this heading">¶</a></h3>
<section id="nvcuda-dll-cannot-be-found-on-windows">
<h4><code class="docutils literal notranslate"><span class="pre">nvcuda.dll</span></code> cannot be found on Windows<a class="headerlink" href="#nvcuda-dll-cannot-be-found-on-windows" title="Permalink to this heading">¶</a></h4>
<p>The <a class="reference external" href="https://github.com/conda-forge/conda-forge-ci-setup-feedstock/blob/master/recipe/install_cuda.bat">scripts</a>
used to install the CUDA Toolkit on Windows cannot provide <code class="docutils literal notranslate"><span class="pre">nvcuda.dll</span></code>
as part of the installation because no GPU is physically present in the CI machines.
As a result, you might get linking errors in the postprocessing steps of <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">build</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WARNING (arrow-cpp,Library/bin/arrow_cuda.dll): $RPATH/nvcuda.dll not found in packages,
sysroot(s) nor the missing_dso_whitelist.

.. is this binary repackaging?
</pre></div>
</div>
<p>For now, you will have to add <code class="docutils literal notranslate"><span class="pre">nvcuda.dll</span></code> to the <code class="docutils literal notranslate"><span class="pre">missing_dso_whitelist</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">build</span><span class="p">:</span>
  <span class="o">...</span>
  <span class="n">missing_dso_whitelist</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;*/nvcuda.dll&quot;</span>   <span class="c1"># [win]</span>
</pre></div>
</div>
</section>
<section id="my-feedstock-is-not-building-old-cuda-versions-anymore">
<h4>My feedstock is not building old CUDA versions anymore<a class="headerlink" href="#my-feedstock-is-not-building-old-cuda-versions-anymore" title="Permalink to this heading">¶</a></h4>
<p>With the <a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock/pull/1162">addition of CUDA 11.1 and 11.2</a>,
the default build matrix for CUDA versions was trimmed down to versions 10.2, 11.0, 11.1, 11.2.</p>
<p>If you really need it, you can re-add support for 9.2, 10.0 and 10.1. However, this is not recommended.
Adding more CUDA versions to the build matrix will dramatically increase the number of jobs and will place a large
burden on our CI resources. Only proceed if there’s a known use case for the extra packages.</p>
<ol class="arabic simple">
<li><p>Download this <a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock/blob/master/recipe/migrations/cuda92_100_101.yaml">migration file</a>.</p></li>
<li><p>In your feedstock fork, create a new branch and place the migration file under <code class="docutils literal notranslate"><span class="pre">.ci_support/migrations</span></code>.</p></li>
<li><p>Open a PR and re-render. CUDA 9.2, 10.0 and 10.1 will appear in the CI checks now. Merge when ready!</p></li>
</ol>
</section>
</section>
<section id="adding-support-for-a-new-cuda-version">
<h3>Adding support for a new CUDA version<a class="headerlink" href="#adding-support-for-a-new-cuda-version" title="Permalink to this heading">¶</a></h3>
<p>Providing a new CUDA version involves five repositores:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/conda-forge/cudatoolkit-feedstock">cudatoolkit-feedstock</a></p></li>
<li><p><a class="reference external" href="https://github.com/conda-forge/nvcc-feedstock">nvcc-feedstock</a></p></li>
<li><p><a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock">conda-forge-pinning-feedstock</a></p></li>
<li><p><a class="reference external" href="https://github.com/conda-forge/docker-images">docker-images</a> (Linux only)</p></li>
<li><p><a class="reference external" href="https://github.com/conda-forge/conda-forge-ci-setup-feedstock">conda-forge-ci-setup-feedstock</a> (Windows only)</p></li>
</ul>
<p>The steps involved are, roughly:</p>
<ol class="arabic simple">
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">cudatoolkit</span></code> packages in <code class="docutils literal notranslate"><span class="pre">cudatoolkit-feedstock</span></code>.</p></li>
<li><p>Submit the version migrator to <code class="docutils literal notranslate"><span class="pre">conda-forge-pinning-feedstock</span></code>.
This will stay open during the following steps.</p></li>
<li><p>For Linux, add the corresponding Docker images at <code class="docutils literal notranslate"><span class="pre">docker-images</span></code>.
Copy the migration file manually to <code class="docutils literal notranslate"><span class="pre">.ci_support/migrations</span></code>.
This copy should not specify a timestamp. Comment it out and rerender.</p></li>
<li><p>For Windows, add the installer URLs and hashes to the <code class="docutils literal notranslate"><span class="pre">conda-forge-ci-setup</span></code>
<a class="reference external" href="https://github.com/conda-forge/conda-forge-ci-setup-feedstock/blob/master/recipe/install_cuda.bat">script</a>.
The migration file must also be manually copied here. Rerender.</p></li>
<li><p>Create the new <code class="docutils literal notranslate"><span class="pre">nvcc</span></code> packages for the new version. Again, manual
migration must be added. Rerender.</p></li>
<li><p>When everything else has been merged and testing has taken place,
consider merging the PR opened at step 2 now so it can apply to all the downstream feedstocks.</p></li>
</ol>
</section>
</section>
<section id="apple-silicon-builds">
<span id="osxarm64"></span><h2>Apple Silicon builds<a class="headerlink" href="#apple-silicon-builds" title="Permalink to this heading">¶</a></h2>
<p>The new Apple M1 processor is the first Apple Silicon supported by conda-forge
<a class="reference external" href="https://github.com/conda-forge/conda-forge.github.io/issues/1126">osx-arm64</a> builds.
For new builds to be available, via cross-compilation, a migration is required for
the package and its dependencies. These builds are experimental as many of them are untested.</p>
<p>To request a migration for a particular package and all its dependencies:</p>
<ol class="arabic simple">
<li><p>Check the feedstock in question to see if there is already an issue or pull request.
Opening an issue here is fine, as it might take a couple iterations of the below,
especially if many dependencies need to be built as well.</p></li>
<li><p>If nothing is under way, look at the current <a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock/blob/master/recipe/migrations/osx_arm64.txt">conda-forge-pinning</a>.</p></li>
<li><p>If the package is not listed there, make a PR, adding the package
name to a random location in <code class="docutils literal notranslate"><span class="pre">osx_arm64.txt</span></code>.
The migration bot should start making automated pull requests to the
repo and its dependencies.</p></li>
<li><p>Within a few hours, the <a class="reference external" href="https://conda-forge.org/status/#armosxaddition">status page</a>
should reflect the progress of the package in question, and help you keep track
of progress. Help out if you can!</p></li>
<li><p>The feedstock maintainers (who very likely <em>do not</em> have an M1) will work to make
any changes required to pass continuous intgration. If you have insight into
the particular package, <strong>please</strong> chime in, but most of all <strong>be patient and polite</strong>.</p></li>
<li><p>Once the new builds are available from <code class="docutils literal notranslate"><span class="pre">anaconda.org</span></code>, please help the maintainers
by testing the packages, and reporting back with any problems… but also successes!</p></li>
</ol>
</section>
<section id="pre-release-builds">
<h2>Pre-release builds<a class="headerlink" href="#pre-release-builds" title="Permalink to this heading">¶</a></h2>
<p>Recipe maintainers can make pre-release builds available on
conda-forge by adding them to the <code class="docutils literal notranslate"><span class="pre">dev</span></code> or <code class="docutils literal notranslate"><span class="pre">rc</span></code> label.</p>
<p>The semantics of these labels should generally follow the
<a class="reference external" href="https://devguide.python.org/developer-workflow/development-cycle/index.html#stages">guidelines</a> that Python
itself follows.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rc</span></code>: <a class="reference external" href="https://devguide.python.org/developer-workflow/development-cycle/index.html#beta">Beta</a> and <a class="reference external" href="https://devguide.python.org/developer-workflow/development-cycle/index.html#release-candidate-rc">Release
Candidate</a>
(RC). No new features. Bugfix only.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dev</span></code>: <a class="reference external" href="https://devguide.python.org/developer-workflow/development-cycle/index.html#pre-alpha">Pre-Alpha</a>
and <a class="reference external" href="https://devguide.python.org/developer-workflow/development-cycle/index.html#alpha">Alpha</a>. These are
still packages that could see substantial changes
between the dev version and the final release.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">alpha</span></code> and <code class="docutils literal notranslate"><span class="pre">beta</span></code> labels aren’t used. Given the light usage of labels on the conda-forge
channel thus far, it seems rather unnecessary to introduce many labels.
<code class="docutils literal notranslate"><span class="pre">dev</span></code> and <code class="docutils literal notranslate"><span class="pre">rc</span></code> seem like a nice compromise.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Certain packages (for example <a class="reference external" href="https://pypi.org/project/black/#history">black</a>) follow
a release cycle in which they have never had a non-beta/alpha release.  In these cases
the conda packages for those do <em>not</em> need to be published to a prerelease label.</p>
</div>
<section id="creating-a-pre-release-build">
<h3>Creating a pre-release build<a class="headerlink" href="#creating-a-pre-release-build" title="Permalink to this heading">¶</a></h3>
<p>To create a <code class="docutils literal notranslate"><span class="pre">dev</span></code> or <code class="docutils literal notranslate"><span class="pre">rc</span></code> package, a PR can be issued into the <code class="docutils literal notranslate"><span class="pre">dev</span></code> or <code class="docutils literal notranslate"><span class="pre">rc</span></code> branch of the
feedstock.
This branch must change the <code class="docutils literal notranslate"><span class="pre">recipe/conda_build_config.yaml</span></code> file to point to the <code class="docutils literal notranslate"><span class="pre">&lt;package_name&gt;_dev</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;package_name&gt;_rc</span></code> label.</p>
<p>For example, matplotlib rc releases would include:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">channel_targets</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge matplotlib_rc</span>
</pre></div>
</div>
<p>If a pre-release build of B depends on a pre-release build of A, then A should have,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">channel_targets</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge A_rc</span>
</pre></div>
</div>
<p>while B should have,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">channel_sources</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge/label/A_rc,conda-forge</span>
<span class="nt">channel_targets</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge B_rc</span>
</pre></div>
</div>
<p>in <code class="docutils literal notranslate"><span class="pre">recipe/conda_build_config.yaml</span></code> in their respective feedstocks.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A rerender needs to happen for these changes to reflect in CI files. The <cite>channel_targets</cite> entries map
<cite>- &lt;channel target&gt; &lt;label target&gt;</cite> pairs for use in the post-build upload step.</p>
</div>
</section>
<section id="installing-a-pre-release-build">
<h3>Installing a pre-release build<a class="headerlink" href="#installing-a-pre-release-build" title="Permalink to this heading">¶</a></h3>
<section id="using-the-conda-cli">
<h4>Using the <cite>conda</cite> CLI<a class="headerlink" href="#using-the-conda-cli" title="Permalink to this heading">¶</a></h4>
<p>Use the following command, but replace <code class="docutils literal notranslate"><span class="pre">PACKAGE_NAME</span></code> with the package you want
to install and replace <code class="docutils literal notranslate"><span class="pre">LABEL</span></code> with <code class="docutils literal notranslate"><span class="pre">rc</span></code> or <code class="docutils literal notranslate"><span class="pre">dev</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">conda install -c conda-forge/label/PACKAGE_NAME_LABEL -c conda-forge PACKAGE_NAME</span>
</pre></div>
</div>
<p>For example, let’s install matplotlib from the <code class="docutils literal notranslate"><span class="pre">rc</span></code> label:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">conda install -c conda-forge/label/matplotlib_rc -c conda-forge matplotlib</span>
</pre></div>
</div>
</section>
<section id="using-environment-yml">
<h4>Using <cite>environment.yml</cite><a class="headerlink" href="#using-environment-yml" title="Permalink to this heading">¶</a></h4>
<p>Use <a class="reference external" href="https://github.com/conda/conda/blob/c3fb8150ed4c3dabb7ca376ade208095f98ee0b9/conda/models/match_spec.py#L70-L150">MatchSpec</a>
to specify your package:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge/label/matplotlib_rc::matplotlib=3.7.0rc1</span>
</pre></div>
</div>
<p>Alternately, you can use the channels section to enable the <cite>matplotlib_rc</cite> channel:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">channels</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge/label/matplotlib_rc</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matplotlib=3.7.0.rc1</span>
</pre></div>
</div>
</section>
</section>
<section id="pre-release-version-sorting">
<h3>Pre-release version sorting<a class="headerlink" href="#pre-release-version-sorting" title="Permalink to this heading">¶</a></h3>
<p>If you wish to add numbers to your <code class="docutils literal notranslate"><span class="pre">dev</span></code> or <code class="docutils literal notranslate"><span class="pre">rc</span></code> build, you should follow the
<a class="reference external" href="https://docs.conda.io/projects/conda/en/stable/user-guide/concepts/pkg-specs.html#version-ordering">guidelines</a> put
forth by Continuum regarding version sorting in <code class="docutils literal notranslate"><span class="pre">conda</span></code>. Also see the <a class="reference external" href="https://github.com/conda/conda/blob/4.2.13/conda/version.py#L93-L119">source
code for conda
4.2.13</a>.
The tl;dr here is that conda sorts as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span> <span class="mf">1.0</span>
<span class="o">&lt;</span> <span class="mf">1.1</span><span class="n">dev1</span>    <span class="c1"># special case &#39;dev&#39;</span>
<span class="o">&lt;</span> <span class="mf">1.1.0</span><span class="n">dev1</span>  <span class="c1"># special case &#39;dev&#39;</span>
<span class="o">==</span> <span class="mf">1.1</span><span class="o">.</span><span class="n">dev1</span>   <span class="c1"># 0 is inserted before string</span>
<span class="o">&lt;</span> <span class="mf">1.1.0</span><span class="n">rc1</span>
<span class="o">&lt;</span> <span class="mf">1.1.0</span>
</pre></div>
</div>
<p>So make sure that you <strong>tag</strong> your package in such a way that the package name
that conda-build spits out will sort the package uploaded with an <code class="docutils literal notranslate"><span class="pre">rc</span></code> label
higher than the package uploaded with the <code class="docutils literal notranslate"><span class="pre">dev</span></code> label.</p>
</section>
</section>
<section id="how-to-update-your-feedstock-token">
<h2>How to update your feedstock token?<a class="headerlink" href="#how-to-update-your-feedstock-token" title="Permalink to this heading">¶</a></h2>
<p>To reset your feedstock token and fix issues with uploads, follow these steps:</p>
<ol class="arabic simple">
<li><p>Create a new text file in the <code class="docutils literal notranslate"><span class="pre">token_reset</span></code> directory of the <code class="docutils literal notranslate"><span class="pre">conda-forge/admin-requests</span></code> repo.</p></li>
<li><p>Add the name of your feedstock in the text file. While adding the name, don’t add “-feedstock” to the end of it. For example: for <code class="docutils literal notranslate"><span class="pre">python-feedstock</span></code>, just add <code class="docutils literal notranslate"><span class="pre">python</span></code>.</p></li>
</ol>
<p>See <a class="reference external" href="https://github.com/conda-forge/admin-requests/blob/main/token_reset/example.txt">token_reset/example.txt</a> for an example.</p>
</section>
<section id="using-arch-rebuild-txt">
<span id="using-arch-rebuild"></span><h2>Using <code class="docutils literal notranslate"><span class="pre">arch_rebuild.txt</span></code><a class="headerlink" href="#using-arch-rebuild-txt" title="Permalink to this heading">¶</a></h2>
<p>You can add a feedstock to <code class="docutils literal notranslate"><span class="pre">arch-rebuild.txt</span></code> if it requires rebuilding with different architectures/platforms (such as ppc64le or aarch64). To add the feedstock to <code class="docutils literal notranslate"><span class="pre">arch_rebuild.txt</span></code>, open a PR to the <a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock">conda-forge-pinning-feedstock repository</a>.
Once the PR is merged, the migration bot goes through the list of feedstocks in <code class="docutils literal notranslate"><span class="pre">arch_rebuild.txt</span></code> and opens a migration PR for any new feedstocks and their dependencies, enabling the aarch64/ppc64le builds.</p>
</section>
<section id="migrators-and-migrations">
<span id="migrations-and-migrators"></span><h2>Migrators and Migrations<a class="headerlink" href="#migrators-and-migrations" title="Permalink to this heading">¶</a></h2>
<p>When any changes are made in the global pinnings of a package, then the entire stack of the packages that need that package on their <code class="docutils literal notranslate"><span class="pre">host</span></code> section would need to be updated and rebuilt.
Doing it manually can be quite tedious, and that’s where migrations come to help. Migrations automate the process of submitting changes to a feedstock and are an integral part of the <code class="docutils literal notranslate"><span class="pre">regro-cf-autotick-bot</span></code>’s duties.</p>
<p>There are several kinds of migrations, which you can read about in <a class="reference external" href="https://regro.github.io/cf-scripts/migrators.html">Making Migrators</a>. To generate these migrations, you use migrators, which are bots that automatically create pull requests for the affected packages in conda-forge.
To propose a migration in one or more pins, the migrator issues a PR into the pinning feedstock using a yaml file expressing the changes to the global pinning file in the migrations folder.
Once the PR is merged, the dependency graph is built. After that, the bot walks through the graph, migrates all the nodes (feedstocks) one by one, and issues PRs for those feedstocks.</p>
<p>Usually, the bot generates these migrations automatically. However, when a pin is first made or added, one may need to be added by hand. To do this, you can follow the steps mentioned in <a class="reference external" href="https://conda-forge.org/docs/maintainer/pinning_deps.html#updating-package-pins">Updating package pins</a>.</p>
<p>The way migrations proceed are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>You make a PR into the <code class="docutils literal notranslate"><span class="pre">migrations</span></code> folder in the <a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock">conda-forge-pinning-feedstock</a> with a new yaml file representing the migration.</p></li>
<li><p>Once the PR is merged, the bot picks it up, builds a migrator graph, and begins the migration process.</p></li>
<li><p>A migration PR is issued for a node (a feedstock) only if:</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>The node depends on the changed pinnings.</p></li>
<li><p>The node has no dependencies that depend on the new pinnings and have not been migrated.</p></li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Process 3 continues until the migration is complete and the change is applied to the global pinning file via a final PR. After this step, we say this migration is closed out.</p></li>
</ol>
</div></blockquote>
<p>Sometimes, you might get a migration PR for your package that you don’t want to merge. In that case, you should put that PR in draft status but should never close it.
If you close the PR, it makes the bot think that another PR implementing the migration is merged instead, letting the migration continue iterating on the graph; however, the downstream dependents fail because the parent (the one we closed the PR of) didn’t really get rebuilt.
Another reason why it is good to keep the PR open or in draft status is that people might help with it if they want in the future.</p>
<p>In some cases a migration PR may not get opened. Please look for
<a class="reference external" href="https://conda-forge.org/status/#current_migrations">the migration on our status page</a>
to see if there are any issues. This may show there are still dependencies
needing migration, in which case the best approach is to wait (or if possible
offer to help migrate those dependencies). If there is a bot error, there will
be a link to the CI job to provide more details about what may have gone wrong.
In these cases <a class="reference external" href="http://github.com/regro/cf-scripts/issues/new">please raise an issue</a>
and include as much information as possible.</p>
<p>It is worth noting that one also has the option to create a migration PR
themselves. This can be a good option if the bot errored and that is still
being investigated or the migration PR got closed accidentally. To migrate a PR manually:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Fork the feedstock and clone it locally</p></li>
<li><p>Create a new branch</p></li>
<li><p>Create the directory <code class="docutils literal notranslate"><span class="pre">.ci_support/migrations</span></code> in the feedstock (if absent)</p></li>
<li><p>Copy the migrator from <a class="reference external" href="https://github.com/conda-forge/conda-forge-pinning-feedstock/tree/main/recipe/migrations">conda-forge-pinning’s migrators</a> to <code class="docutils literal notranslate"><span class="pre">.ci_support/migrations</span></code> and commit it</p></li>
<li><p><a class="reference internal" href="updating_pkgs.html#dev-update-rerender"><span class="std std-ref">Rerender</span></a> the feedstock</p></li>
<li><p>Push these changes and open a PR</p></li>
</ol>
</div></blockquote>
</section>
<section id="security-considerations-for-conda-forge-builds">
<h2>Security considerations for conda-forge builds<a class="headerlink" href="#security-considerations-for-conda-forge-builds" title="Permalink to this heading">¶</a></h2>
<p>All <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> packages are built by strangers on the internet on public cloud infrastructure from source code you likely have not inspected, so you should not use <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> packages if you or your team require a high level of security.
You are also free to download recipes and rebuild them yourself, if you would like at least that much oversight. However, many people use <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> all the time with no issues and here are some things that <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> does to help with security in some ways:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://conda-forge.org/docs/maintainer/adding_pkgs.html#source">Sources</a> (where you specify where the package’s source code is coming from) can be pulled from GitHub, PyPI, or other sources and sha256 hashes are always used, so moving of tags or uploading of new sdists can not cause automatic package rebuilds.
Also, once packages are accepted and made into feedstocks, only the maintainers of that feedstock have the right to merge PRs made to that feedstock.</p></li>
<li><p>Each feedstock can only upload packages for that feedstock. This is enforced by using a cf-staging channel where builds are first sent.
A bot then assesses that the submitting feedstock has permission to build the package it has submitted, and only then will it relay the build to the conda-forge channel.
This helps mitigate against a bad actor gaining access to an inconspicuous feedstock and then trying to push a build with malicious code into essential infrastructure packages (e.g., OpenSSL or Python).</p></li>
<li><p>We have <a class="reference external" href="https://github.com/conda-forge/artifact-validation">artifact-validation</a> for validating all the <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> artifacts uploaded to <code class="docutils literal notranslate"><span class="pre">anaconda.org</span></code>. This validation scans for various security-related items, such as artifacts that overwrite key pieces of certain packages.</p></li>
<li><p>We have a dedicated <a class="reference external" href="https://conda-forge.org/docs/orga/subteams.html?highlight=security+team#security-and-systems-sub-team">Security and Systems Sub-Team</a> who works hard towards making sure to secure and maintain appropriate access to the credentials and services/systems used by <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code>.</p></li>
</ol>
</section>
<section id="significant-changes-to-upstream-projects">
<h2>Significant Changes To Upstream Projects<a class="headerlink" href="#significant-changes-to-upstream-projects" title="Permalink to this heading">¶</a></h2>
<p>From time to time, we make changes in upstream projects so that they better integrate into the <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> ecosystem. We
have listed some, but not all, of those changes here for specific projects along with any associated documentation.</p>
<section id="python">
<h3>Python<a class="headerlink" href="#python" title="Permalink to this heading">¶</a></h3>
<p>We carry an extensive set of python patches that change some core behaviors around search paths, environment isolation
in conda environments, and some operating system limits. See the <a class="reference external" href="https://github.com/conda-forge/python-feedstock">python feedstock</a> for more details.</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="../index.html">Overview</a></h3>
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/00_intro.html">User Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="00_intro.html">Maintainer Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="infrastructure.html">Infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="adding_pkgs.html">Contributing packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="updating_pkgs.html">Maintaining packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="pinning_deps.html">Pinned dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="conda_forge_yml.html">Configuring conda-forge.yml</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Knowledge Base</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-cmake">Using CMake</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#moving-from-an-autotools-build-to-a-cmake-build">Moving from an autotools build to a CMake build</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#particularities-on-windows">Particularities on Windows</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#local-testing">Local testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-cmake-based-bld-bat">Simple CMake-Based <code class="docutils literal notranslate"><span class="pre">bld.bat</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-for-different-vc-versions">Building for different VC versions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-vs2019">Using vs2019</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tips-tricks-for-cmd-batch-syntax">Tips &amp; tricks for CMD/Batch syntax</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#special-dependencies-and-packages">Special Dependencies and Packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#compilers">Compilers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cross-compilation">Cross-compilation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rust-nightly">Rust Nightly</a></li>
<li class="toctree-l4"><a class="reference internal" href="#core-dependency-tree-packages-cdts">Core Dependency Tree Packages (CDTs)</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#libgl">libGL</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#building-against-numpy">Building Against NumPy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jupyterlab-extensions">JupyterLab Extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#message-passing-interface-mpi">Message passing interface (MPI)</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#mpi-variants-in-conda-forge">MPI Variants in conda-forge</a></li>
<li class="toctree-l5"><a class="reference internal" href="#building-mpi-variants">Building MPI variants</a></li>
<li class="toctree-l5"><a class="reference internal" href="#including-a-no-mpi-build">Including a no-mpi build</a></li>
<li class="toctree-l5"><a class="reference internal" href="#preferring-a-provider-usually-nompi">Preferring a provider (usually nompi)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#complete-example">Complete example</a></li>
<li class="toctree-l5"><a class="reference internal" href="#just-mpi-example">Just mpi example</a></li>
<li class="toctree-l5"><a class="reference internal" href="#mpi-compiler-packages">MPI Compiler Packages</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#openmp">OpenMP</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#switching-openmp-implementation">Switching OpenMP implementation</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#yum-requirements-txt">yum_requirements.txt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#blas">BLAS</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#switching-blas-implementation">Switching BLAS implementation</a></li>
<li class="toctree-l5"><a class="reference internal" href="#how-it-works">How it works</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#matplotlib">Matplotlib</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pybind11-abi-constraints"><code class="docutils literal notranslate"><span class="pre">pybind11</span></code> ABI Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#empty-python-packages">Empty Python packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-version-specific-python-packages">Non-version-specific Python packages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#noarch-builds">Noarch builds</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#noarch-python">Noarch python</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#noarch-packages-with-os-specific-dependencies">Noarch packages with OS-specific dependencies</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#noarch-generic">Noarch generic</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#build-matrices">Build matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requiring-newer-macos-sdks">Requiring newer macOS SDKs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#newer-c-features-with-old-sdk">Newer C++ features with old SDK</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pypy-builds">PyPy builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-setuptools-scm">Using setuptools_scm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-centos-7">Using CentOS 7</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cuda-builds">CUDA builds</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#testing-the-packages">Testing the packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#common-problems-and-known-issues">Common problems and known issues</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#nvcuda-dll-cannot-be-found-on-windows"><code class="docutils literal notranslate"><span class="pre">nvcuda.dll</span></code> cannot be found on Windows</a></li>
<li class="toctree-l5"><a class="reference internal" href="#my-feedstock-is-not-building-old-cuda-versions-anymore">My feedstock is not building old CUDA versions anymore</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#adding-support-for-a-new-cuda-version">Adding support for a new CUDA version</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#apple-silicon-builds">Apple Silicon builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pre-release-builds">Pre-release builds</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-pre-release-build">Creating a pre-release build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-a-pre-release-build">Installing a pre-release build</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#using-the-conda-cli">Using the <cite>conda</cite> CLI</a></li>
<li class="toctree-l5"><a class="reference internal" href="#using-environment-yml">Using <cite>environment.yml</cite></a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#pre-release-version-sorting">Pre-release version sorting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-update-your-feedstock-token">How to update your feedstock token?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-arch-rebuild-txt">Using <code class="docutils literal notranslate"><span class="pre">arch_rebuild.txt</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#migrators-and-migrations">Migrators and Migrations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#security-considerations-for-conda-forge-builds">Security considerations for conda-forge builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#significant-changes-to-upstream-projects">Significant Changes To Upstream Projects</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#python">Python</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="maintainer_faq.html">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../orga/00_intro.html">Organisation Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/00_intro.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contracting/00_intro.html">Contracting Information</a></li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="conda_forge_yml.html"
                          title="Previous page">&larr; Configuring conda-forge.yml</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="maintainer_faq.html"
                          title="Next page">&rarr; FAQ</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/maintainer/knowledge_base.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="maintainer_faq.html" title="FAQ"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="conda_forge_yml.html" title="Configuring conda-forge.yml"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">conda-forge 2023.06.22 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="00_intro.html" >Maintainer Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Knowledge Base</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2023, conda-forge.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>